<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel ID - Ultimate Atlas</title>
    <link rel="icon" href="./images/logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9SCPDPG40L"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9SCPDPG40L');</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root{--primary:#3b82f6;--accent:#8b5cf6;--bg:#f8fafc;--card:#ffffff;--text:#1e293b;--x-color:#000000;--discord-color:#5865F2;--danger:#ef4444;--match:#db2777;--insta-grad:linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);}
        body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",YuGothic,sans-serif;background-color:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.6;}
        .container{background:var(--card);width:100%;max-width:500px;margin:0 auto;padding:30px;border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,0.08);text-align:center;position:relative;overflow:hidden;}
        
        .mode-switch-container { display: flex; justify-content: center; margin: 20px 0; }
        .mode-switch { display: flex; background: #e2e8f0; border-radius: 30px; padding: 4px; position: relative; cursor: pointer; width: 200px; height: 40px; align-items: center; }
        .mode-option { flex: 1; text-align: center; font-weight: bold; font-size: 14px; z-index: 2; color: #64748b; transition: color 0.3s; }
        .mode-option.active { color: white; }
        .mode-bg { position: absolute; top: 2px; left: 2px; width: 50%; height: 36px; background: var(--primary); border-radius: 28px; transition: left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 1; }
        .mode-switch.japan-mode .mode-bg { left: 50%; background: #ef4444; }

        #map-container { width: 100%; height: 350px; border-radius: 16px; margin-top: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; border: 2px solid #e2e8f0; background: #eee;}
        #map { width: 100%; height: 100%; }
        
        .lang-switch{position:absolute;top:20px;right:20px;background:#f1f5f9;padding:5px 10px;border-radius:20px;font-size:12px;font-weight:bold;cursor:pointer;border:1px solid #e2e8f0;color:#64748b;}
        h1{font-size:24px;margin:10px 0;font-weight:800;margin-top:20px;}
        h2{font-size:16px;color:#64748b;margin-bottom:30px;font-weight:normal;}
        .app-logo{display:block;margin:30px auto;width:240px;max-width:70%;height:auto;}
        
        /* Quiz UI */
        .options-list{text-align:left;display:flex;flex-direction:column;gap:12px;margin-bottom:30px;}
        .option-label{display:flex;align-items:center;padding:15px;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:0.2s;}
        .option-label:hover{background-color:#f8fafc;border-color:#cbd5e1;}
        .option-label.selected{border-color:var(--primary);background-color:#eff6ff;}
        .option-radio{margin-right:15px;transform:scale(1.2);accent-color:var(--primary);}
        .nav-buttons{display:flex;justify-content:space-between;gap:15px;}
        .nav-btn{flex:1;padding:14px;border-radius:12px;border:none;font-weight:bold;cursor:pointer;font-size:16px;}
        .btn-back{background:#e2e8f0;color:#64748b;}
        .btn-next{background:var(--primary);color:white;}
        .btn-next:disabled{opacity:0.5;cursor:not-allowed;}
        .question-text{font-size:18px;font-weight:700;margin-bottom:20px;min-height:60px;display:flex;align-items:center;justify-content:center;}
        .progress-bar{height:6px;background:#e2e8f0;margin-bottom:20px;border-radius:3px;overflow:hidden;}
        .progress-fill{height:100%;background:var(--primary);width:0%;transition:width 0.3s;}

        .info-box{background:#f1f5f9;border-radius:16px;padding:20px;text-align:left;margin-bottom:15px;border:1px solid #e2e8f0;}
        .info-title{font-size:12px;font-weight:bold;color:#64748b;margin-bottom:5px;text-transform:uppercase;}
        .info-content{font-size:16px;font-weight:bold;color:#334155;}
        .insta-btn { display: block; width: 100%; margin-top: 15px; padding: 12px; background: var(--insta-grad); color: white; border: none; border-radius: 12px; font-weight: bold; text-decoration: none; text-align: center; box-sizing: border-box; transition: 0.2s;}
        .insta-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .share-area { display: flex; gap: 10px; margin: 20px 0; }
        button.share-btn { flex: 1; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s;}
        button.share-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .x { background: var(--x-color); } .discord { background: var(--discord-color); }
        
        .hidden{display:none;}
        .fade-in{animation:fadeIn 0.6s ease-out;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}

        .map-card { width: 180px; }
        .map-card h4 { margin: 0 0 5px 0; font-size: 14px; color: #1e293b; }
        .map-card p { font-size: 11px; margin: 0; color: #64748b; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-switch" onclick="toggleLanguage()" id="lang-btn">ğŸ‡¯ğŸ‡µ JP / ğŸ‡ºğŸ‡¸ EN</div>

    <div id="start-screen">
        <h1 id="start-title">Travel ID è¨ºæ–­</h1>
        <h2 id="start-subtitle">ã‚ãªãŸã®æ—…ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’<br>13å•ã§è§£æ˜ã—ã¾ã™ã€‚</h2>
        <img src="./images/logo.png" alt="Travel ID Logo" class="app-logo">
        <button class="start-btn" onclick="startQuiz()" id="start-btn-text" style="background:linear-gradient(135deg,var(--primary),var(--accent));color:white;border:none;font-size:20px;padding:20px 40px;width:100%;border-radius:16px;font-weight:bold;cursor:pointer;">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
        <p style="font-size:10px; color:#cbd5e1; margin-top:15px;">v18.1 (Map Fix & Data Clean)</p>
    </div>

    <div id="quiz-screen" class="hidden">
        <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
        <div class="question-text" id="question-text">Loading...</div>
        <div class="options-list" id="options-container"></div>
        <div class="nav-buttons">
            <button class="nav-btn btn-back" onclick="prevQuestion()" id="btn-back">æˆ»ã‚‹</button>
            <button class="nav-btn btn-next" onclick="nextQuestion()" id="btn-next" disabled>æ¬¡ã¸</button>
        </div>
    </div>

    <div id="pre-result-screen" class="hidden fade-in">
        <h1 id="pre-title">è¨ºæ–­å®Œäº†ï¼</h1>
        <p id="pre-subtitle">æœ€å¾Œã®ä»•ä¸Šã’ã§ã™ã€‚<br>MBTIã‚’è¿½åŠ ã™ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚</p>
        <div style="margin:20px 0;text-align:left;">
            <label style="font-size:14px;font-weight:bold;color:#64748b;">MBTI (ä»»æ„):</label>
            <select id="mbti-select" style="width:100%;padding:12px;margin-top:5px;border-radius:12px;border:2px solid #e2e8f0;background:#f8fafc;">
                <option value="">ã‚ã‹ã‚‰ãªã„ / Skip</option>
                <option value="INTJ">INTJ</option><option value="INTP">INTP</option><option value="ENTJ">ENTJ</option><option value="ENTP">ENTP</option>
                <option value="INFJ">INFJ</option><option value="INFP">INFP</option><option value="ENFJ">ENFJ</option><option value="ENFP">ENFP</option>
                <option value="ISTJ">ISTJ</option><option value="ISFJ">ISFJ</option><option value="ESTJ">ESTJ</option><option value="ESFJ">ESFJ</option>
                <option value="ISTP">ISTP</option><option value="ISFP">ISFP</option><option value="ESTP">ESTP</option><option value="ESFP">ESFP</option>
            </select>
        </div>
        <button class="start-btn" onclick="calcAndShowResults()" id="show-result-btn-text" style="background:var(--primary);color:white;border:none;font-size:20px;padding:20px 40px;width:100%;border-radius:16px;font-weight:bold;cursor:pointer;">çµæœã‚’è¦‹ã‚‹</button>
    </div>

    <div id="result-screen" class="hidden fade-in">
        <img id="result-image" src="" alt="Result" style="width:100%;border-radius:16px;margin-bottom:20px;">
        <h2 style="color:#3b82f6;margin-bottom:5px;" id="result-label">ã‚ãªãŸã®ID</h2>
        <h1 id="result-id" style="font-size:42px;margin:0 0 10px 0;background:linear-gradient(45deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900;"></h1>
        <p id="result-desc" style="font-size:14px;color:#64748b;font-weight:bold;"></p>

        <div class="mode-switch-container">
            <div class="mode-switch" onclick="toggleMapMode()" id="mode-switch">
                <div class="mode-bg"></div>
                <div class="mode-option active" id="opt-world">ğŸŒ World</div>
                <div class="mode-option" id="opt-japan">ğŸ‡¯ğŸ‡µ Japan</div>
            </div>
        </div>

        <div class="info-box">
            <div class="info-title" id="rec-label">ğŸ—ºï¸ ãŠã™ã™ã‚ã®æ—…å…ˆ</div>
            <div class="info-content" id="rec-content">Loading data...</div>
            <a href="#" target="_blank" class="insta-btn" id="insta-link">ğŸ“· ã“ã®å ´æ‰€ã‚’å‹•ç”»ã§è¦‹ã‚‹</a>
        </div>

        <div id="map-container"><div id="map"></div></div>

        <div class="share-area">
            <button class="share-btn x" onclick="shareOnX()">X (Twitter)</button>
            <button class="share-btn discord" onclick="copyForDiscord()">Discord</button>
        </div>
        
        <button onclick="location.reload()" style="margin-top:20px;background:#f1f5f9;border:none;padding:12px 20px;border-radius:20px;width:100%;color:#64748b;font-weight:bold;cursor:pointer;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // â˜…â˜…â˜…â˜… ã‚ãªãŸã®Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL â˜…â˜…â˜…â˜…
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRrOI46FP-ueet2ZD0xKG0r1_xFng90_PDr1Z-sm6OB5xe3I8m0nx5Q5aNIVxvRVi1QLczBbv4pdnAv/pub?output=csv'; 

    let currentLang = 'ja';
    let currentMode = 'world'; 
    let finalId = "";
    let map = null;
    let markers = [];
    let japanDataCache = {}; 
    let currentSpotName = ""; // ã‚·ã‚§ã‚¢ç”¨å¤‰æ•°

    // --- Data Fetching (With Cleaning) ---
    function fetchJapanData() {
        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log("Raw CSV:", results.data); 
                results.data.forEach(row => {
                    if(row.id) {
                        // ã€ä¿®æ­£ã€‘ã‚­ãƒ¼ã¨å€¤ã®ç©ºç™½ã‚’å¾¹åº•çš„ã«å‰Šé™¤
                        const cleanId = row.id.trim();
                        const cleanTag = row.tag ? row.tag.trim() : "";
                        
                        if (!japanDataCache[cleanId]) japanDataCache[cleanId] = [];
                        japanDataCache[cleanId].push({
                            rec: row.rec_jp ? row.rec_jp.trim() : "",
                            rec_en: row.rec_en ? row.rec_en.trim() : "",
                            desc: row.desc ? row.desc.trim() : "Recommended by Travel ID",
                            tag: cleanTag,
                            lat: parseFloat(row.lat),
                            lng: parseFloat(row.lng),
                            zoom: parseInt(row.zoom) || 12 // Default zoom
                        });
                    }
                });
                console.log("Cleaned Data:", japanDataCache);
            }
        });
    }
    fetchJapanData();

    // --- Translations ---
    const translations = {
        ja: {
            title: "Travel ID è¨ºæ–­", subtitle: "ã‚ãªãŸã®æ—…ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’<br>13å•ã§è§£æ˜ã—ã¾ã™ã€‚", startBtn: "è¨ºæ–­ã‚’å§‹ã‚ã‚‹", btnNext: "æ¬¡ã¸", btnBack: "æˆ»ã‚‹",
            labelRec: "ğŸ—ºï¸ ãŠã™ã™ã‚ã®æ—…å…ˆ", instaBtn: "ğŸ“· ã“ã®å ´æ‰€ã‚’å‹•ç”»ã§è¦‹ã‚‹",
            preTitle: "è¨ºæ–­å®Œäº†ï¼", preSubtitle: "æœ€å¾Œã®ä»•ä¸Šã’ã§ã™ã€‚<br>MBTIã‚’è¿½åŠ ã™ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚", showResultBtn: "çµæœã‚’è¦‹ã‚‹",
            world: "ğŸŒ ä¸–ç•Œ", japan: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬"
        },
        en: {
            title: "Travel ID Diagnosis", subtitle: "Discover your true travel style.", startBtn: "Start Quiz", btnNext: "Next", btnBack: "Back",
            labelRec: "ğŸ—ºï¸ Recommended", instaBtn: "ğŸ“· See Vibe on Instagram",
            preTitle: "Almost Done!", preSubtitle: "Add MBTI for better accuracy.", showResultBtn: "See Results",
            world: "ğŸŒ World", japan: "ğŸ‡¯ğŸ‡µ Japan"
        }
    };

    // --- 13 Questions Data ---
    const questions=[{ja:"çµ¶æ™¯ã®ãŸã‚ãªã‚‰ã€ã‚·ãƒ£ãƒ¯ãƒ¼ã®ãªã„ä¸è¡›ç”Ÿãªå®¿ã§ã‚‚æˆ‘æ…¢ã§ãã‚‹ã€‚",en:"I can endure poor hygiene for a great view.",pos:{mud:2,active:1},neg:{clean:2,safe:1}},{ja:"ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ±ºã‚ãšã€ãã®å ´ã®æ°—åˆ†ã§å‹•ããŸã„ã€‚",en:"I prefer spontaneity over planning.",pos:{flow:2,safe:0.5},neg:{order:2,active:0.5}},{ja:"å®‰å…¨ãªãƒªã‚¾ãƒ¼ãƒˆã‚ˆã‚Šã€å°‘ã—å±é™ºãªè·¯åœ°è£ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã€‚",en:"Gritty alleys excite me more than safe resorts.",pos:{active:2,mud:1},neg:{safe:2,clean:1}},{ja:"é£Ÿäº‹ã¯å€‹å®¤ã‚ˆã‚Šã‚‚ã€ç¾åœ°ã®äººã¨ç›¸å¸­ã«ãªã‚‹ã‚ˆã†ãªåº—ãŒã„ã„ã€‚",en:"I prefer lively local eateries over private dining.",pos:{social:2,mud:0.5},neg:{solo:2,clean:0.5}},{ja:"ãƒˆãƒ©ãƒ–ãƒ«ï¼ˆé›»è»Šé…å»¶ãªã©ï¼‰ã‚‚ã€Œé¢ç™½ã„å±•é–‹ã€ã ã¨æ¥½ã—ã‚ã‚‹ã€‚",en:"Travel troubles are interesting twists, not panic.",pos:{flow:2,active:1},neg:{order:2,safe:1}},{ja:"è¨€è‘‰ãŒé€šã˜ãªã„å ´æ‰€ã§ã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼äº¤æ¸‰ã¯æ¥½ã—ã„ã€‚",en:"Communicating with gestures is fun.",pos:{active:2,social:1},neg:{safe:2,solo:1}},{ja:"äºˆç®—ãŒã‚ã‚Œã°ã€é«˜ç´šãƒ›ãƒ†ãƒ«ã‚ˆã‚Šã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã«ä½¿ã„ãŸã„ã€‚",en:"I spend extra budget on activities, not hotels.",pos:{active:2,mud:0.5},neg:{clean:2,safe:0.5}},{ja:"èª°ã¨ã‚‚è©±ã•ãšå¤§è‡ªç„¶ã§ä¸€äººãã‚Šã€‚ãã‚Œã¯è‡³ç¦ã®æ™‚é–“ã ã€‚",en:"Being alone in nature is bliss.",pos:{solo:2,mud:1},neg:{social:2,safe:1}},{ja:"è¦‹ãŸã“ã¨ã®ãªã„è¬ã®å±‹å°æ–™ç†ã‚‚ã€è¿·ã‚ãšé£Ÿã¹ã‚‹ã€‚",en:"I try mysterious street food without hesitation.",pos:{mud:2,active:1},neg:{clean:2,safe:1}},{ja:"æ—…ã®ç›®çš„ã¯ã€Œç™’ã‚„ã—ã€ã‚ˆã‚Šã€Œä¾¡å€¤è¦³ã‚’å£Šã™åˆºæ¿€ã€ã ã€‚",en:"Travel is for culture shock, not relaxation.",pos:{active:2,flow:1},neg:{safe:2,order:1}},{ja:"è‡ªåˆ†ã«åˆã‚ã›ã¦ãã‚Œã‚‹äººã‚ˆã‚Šã€æŒ¯ã‚Šå›ã—ã¦ãã‚‹äººãŒã„ã„ã€‚",en:"I prefer crazy travel companions over passive ones.",pos:{flow:2,social:1},neg:{order:2,solo:1}},{ja:"è·é€ ã‚Šã¯ã€Œã‚‚ã—ã‚‚ã€ã‚’è€ƒãˆã¦å¤šããªã‚‹æ–¹ã ã€‚",en:"I overpack for 'what if' scenarios.",pos:{order:2,safe:1},neg:{flow:2,mud:1}},{ja:"æ¯æœã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã¯æ—…å…ˆã§ã‚‚å®ˆã‚ŠãŸã„ã€‚",en:"I keep my morning routine even when traveling.",pos:{order:2,clean:0.5},neg:{flow:2,active:0.5}}];
    const optionsData=[{ja:"å®Œå…¨ã«ãã†æ€ã†",en:"Strongly Agree",weight:1.0,type:"pos"},{ja:"ã‚„ã‚„ãã†æ€ã†",en:"Agree",weight:0.5,type:"pos"},{ja:"ã©ã¡ã‚‰ã§ã‚‚ãªã„",en:"Neutral",weight:0,type:"neu"},{ja:"ã‚ã¾ã‚Šãã†æ€ã‚ãªã„",en:"Disagree",weight:0.5,type:"neg"},{ja:"å…¨ããã†æ€ã‚ãªã„",en:"Strongly Disagree",weight:1.0,type:"neg"}];
    
    // Result Data (Full World Mock)
    const resultData = {
        "æ³¥æ”»å­¤éŠ": { ja: { title: "å­¤é«˜ã®ãƒãƒ¼ãƒ‰ã‚³ã‚¢å†’é™ºå®¶", desc: "å¿«é©ã•ã‚ˆã‚Šç”Ÿã®å®Ÿæ„Ÿã€‚ç›´æ„Ÿã§å‹•ãã€‚" }, en: { title: "The Adventurer", desc: "Raw reality over comfort." }, world: [{ rec: "ã‚¨ãƒã‚ªãƒ”ã‚¢ï¼ˆãƒ€ãƒŠã‚­ãƒ«ç ‚æ¼ ï¼‰", rec_en: "Ethiopia", tag: "AdventureTravel", lat: 14.0323, lng: 40.2936, desc: "åœ°çƒä¸Šã§æœ€ã‚‚éé…·ãªå ´æ‰€ã€‚" }] },
        "æµ„å®‰å…±å¾‹": { ja: { title: "ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãƒ¼", desc: "æ¸…æ½”ã¨ç§©åºã‚’æ„›ã™ã‚‹å®Œç’§ä¸»ç¾©è€…ã€‚" }, en: { title: "The Coordinator", desc: "Cleanliness and order." }, world: [{ rec: "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ï¼ˆãƒãƒªãƒ¼ãƒŠãƒ™ã‚¤ï¼‰", rec_en: "Singapore", tag: "LuxuryTravel", lat: 1.2834, lng: 103.8607, desc: "å®Œç’§ãªã‚¤ãƒ³ãƒ•ãƒ©ã¨è¡›ç”Ÿç®¡ç†ã€‚" }] },
        "æ³¥æ”»å­¤å¾‹": { ja: { title: "ã‚¹ãƒˆã‚¤ãƒƒã‚¯ãªæ¢æ¤œå®¶", desc: "éé…·ãªç›®æ¨™ã¸ã®æº–å‚™ã‚’æ€ ã‚‰ãªã„ã€‚" }, en: { title: "The Stoic Explorer", desc: "Meticulous prep." }, world: [{ rec: "ãƒ‘ã‚¿ã‚´ãƒ‹ã‚¢", rec_en: "Patagonia", tag: "Patagonia", lat: -48.4239, lng: -72.5630, desc: "è’é‡ã®å­¤ç‹¬ã¨çµ¶æ™¯ã€‚" }] },
        "æ³¥æ”»å…±éŠ": { ja: { title: "ãŠç¥­ã‚Šé¨’ãã®ã‚µãƒã‚¤ãƒãƒ¼", desc: "æ··æ²Œã¨é¨’éŸ³ã‚’æ„›ã™ã‚‹ã€‚" }, en: { title: "The Party Survivor", desc: "Loves chaos." }, world: [{ rec: "ã‚¤ãƒ³ãƒ‰ï¼ˆãƒãƒ©ãƒŠã‚·ï¼‰", rec_en: "Varanasi", tag: "Varanasi", lat: 25.3176, lng: 82.9739, desc: "ç”Ÿã¨æ­»ãŒæ··åœ¨ã™ã‚‹ã‚«ã‚ªã‚¹ã€‚" }] },
        "æ³¥æ”»å…±å¾‹": { ja: { title: "éé…·ãƒ„ã‚¢ãƒ¼ã®ç†±è¡€ãƒªãƒ¼ãƒ€ãƒ¼", desc: "ãƒãƒ¼ãƒ‰ãªæ—…ã‚’çµ±ç‡ã™ã‚‹ã€‚" }, en: { title: "The Leader", desc: "Leads hardcore trips." }, world: [{ rec: "ã‚­ãƒªãƒãƒ³ã‚¸ãƒ£ãƒ­", rec_en: "Kilimanjaro", tag: "Kilimanjaro", lat: -3.0674, lng: 37.3556, desc: "ãƒãƒ¼ãƒ ã§æŒ‘ã‚€æœ€é«˜å³°ã€‚" }] },
        "æ³¥å®‰å­¤éŠ": { ja: { title: "ãƒ‡ã‚£ãƒ¼ãƒ—ãªè¡—ã®æ”¾æµªè©©äºº", desc: "è·¯åœ°è£ã®ç”Ÿæ´»æ„Ÿã‚’æ„›ã™ã‚‹ã€‚" }, en: { title: "The Poet", desc: "Loves gritty alleys." }, world: [{ rec: "ãƒ™ãƒˆãƒŠãƒ ï¼ˆãƒãƒã‚¤æ—§å¸‚è¡—ï¼‰", rec_en: "Hanoi", tag: "Hanoi", lat: 21.0285, lng: 105.8542, desc: "ãƒã‚¤ã‚¯ã®é¨’éŸ³ã¨è·¯ä¸Šã®ãƒ•ã‚©ãƒ¼ã€‚" }] },
        "æ³¥å®‰å­¤å¾‹": { ja: { title: "ãƒãƒ‹ã‚¢ãƒƒã‚¯ãªç ”ç©¶è€…", desc: "ãƒ‹ãƒƒãƒãªå¯¾è±¡ã«æ²¡å…¥ã™ã‚‹ã€‚" }, en: { title: "The Researcher", desc: "Immersion in niche." }, world: [{ rec: "ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«ãƒ¯ãƒƒãƒˆ", rec_en: "Angkor Wat", tag: "AngkorWat", lat: 13.4125, lng: 103.8670, desc: "å¯†æ—ã«çœ ã‚‹å·¨å¤§éºè·¡ã€‚" }] },
        "æ³¥å®‰å…±éŠ": { ja: { title: "ä¸‹ç”ºã®æ„›ã•ã‚Œã‚­ãƒ£ãƒ©", desc: "ç¾åœ°ã®äººã¨å³ä»²è‰¯ããªã‚‹ã€‚" }, en: { title: "The Local's Favorite", desc: "Friends with locals." }, world: [{ rec: "ã‚¿ã‚¤ï¼ˆã‚«ã‚ªã‚µãƒ³é€šã‚Šï¼‰", rec_en: "Khao San Road", tag: "KhaoSan", lat: 13.7589, lng: 100.4974, desc: "ãƒãƒƒã‚¯ãƒ‘ãƒƒã‚«ãƒ¼ã®è–åœ°ã€‚" }] },
        "æ³¥å®‰å…±å¾‹": { ja: { title: "æ¿€å®‰ãƒ„ã‚¢ãƒ¼ã®ã—ã£ã‹ã‚Šè€…", desc: "å®‰ããƒ‡ã‚£ãƒ¼ãƒ—ã«ã€‚ç„¡é§„ã‚’å«Œã†ã€‚" }, en: { title: "The Budget Master", desc: "Cheap and deep." }, world: [{ rec: "å°æ¹¾ï¼ˆä¹ä»½ï¼‰", rec_en: "Jiufen", tag: "Jiufen", lat: 25.1098, lng: 121.8452, desc: "ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯ãªçŸ³æ®µã®è¡—ã€‚" }] },
        "æµ„æ”»å­¤éŠ": { ja: { title: "ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãªè‡ªç”±äºº", desc: "æ´—ç·´ã¨è‡ªç”±ã‚’æ„›ã™ã‚‹ã€‚" }, en: { title: "The Free Spirit", desc: "Style and freedom." }, world: [{ rec: "ãƒãƒªå³¶ï¼ˆã‚¦ãƒ–ãƒ‰ï¼‰", rec_en: "Ubud", tag: "Ubud", lat: -8.5069, lng: 115.2625, desc: "ãƒ¨ã‚¬ã¨ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ãƒ•ãƒ¼ãƒ‰ã€‚" }] },
        "æµ„æ”»å­¤å¾‹": { ja: { title: "å®Œç’§ä¸»ç¾©ã®çµ¶æ™¯ãƒãƒ³ã‚¿ãƒ¼", desc: "æœ€é«˜ã®ç¬é–“ã®ãŸã‚ã«å‹•ãã€‚" }, en: { title: "The Perfectionist", desc: "Perfect shot." }, world: [{ rec: "ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰", rec_en: "Iceland", tag: "Iceland", lat: 64.9631, lng: -19.0208, desc: "ç«ã¨æ°·ã®çµ¶æ™¯ã€‚" }] },
        "æµ„æ”»å…±éŠ": { ja: { title: "ã‚­ãƒ©ã‚­ãƒ©å¥³å­æ—…ã®ã‚«ãƒªã‚¹ãƒ", desc: "ãƒˆãƒ¬ãƒ³ãƒ‰ã¨æ˜ ãˆã‚’å·¡ã‚‹ã€‚" }, en: { title: "The Trendy Charisma", desc: "Trends and photos." }, world: [{ rec: "éŸ“å›½ï¼ˆã‚½ã‚¦ãƒ«ï¼‰", rec_en: "Seoul", tag: "Seoul", lat: 37.5665, lng: 126.9780, desc: "æœ€æ–°ã‚«ãƒ•ã‚§ã¨ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³ã€‚" }] },
        "æµ„æ”»å…±å¾‹": { ja: { title: "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ãƒªã‚¾ãƒ¼ãƒˆã®å¹¹äº‹é•·", desc: "å¿«é©ã‹ã¤æ´»å‹•çš„ãªå®Œç’§ãªæ—…ã€‚" }, en: { title: "The Planner", desc: "Active luxury." }, world: [{ rec: "ãƒ‰ãƒã‚¤", rec_en: "Dubai", tag: "Dubai", lat: 25.2048, lng: 55.2708, desc: "ç ‚æ¼ ã®ãƒ©ã‚°ã‚¸ãƒ¥ã‚¢ãƒªãƒ¼ã€‚" }] },
        "æµ„å®‰å­¤éŠ": { ja: { title: "å„ªé›…ãªãƒ›ãƒ†ãƒ«ã‚¹ãƒ†ã‚¤æ„›å¥½å®¶", desc: "ä½•ã‚‚ã—ãªã„è´…æ²¢ã€‚" }, en: { title: "The Hotel Lover", desc: "Luxury of doing nothing." }, world: [{ rec: "ãƒ‘ãƒª", rec_en: "Paris", tag: "Paris", lat: 48.8566, lng: 2.3522, desc: "ã‚»ãƒ¼ãƒŒå·æ²¿ã„ã®æ•£æ­©ã€‚" }] },
        "æµ„å®‰å­¤å¾‹": { ja: { title: "æ…é‡æ´¾ã®ç™’ã‚„ã—æ±‚é“è€…", desc: "å®‰å…¨ã§æ¸…æ½”ãªç™’ã‚„ã—ã€‚" }, en: { title: "The Healer", desc: "Safe and clean." }, world: [{ rec: "ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰", rec_en: "Finland", tag: "Finland", lat: 61.9241, lng: 25.7482, desc: "æ¹–ç•”ã®ã‚µã‚¦ãƒŠã¨é™å¯‚ã€‚" }] },
        "æµ„å®‰å…±éŠ": { ja: { title: "ã®ã‚“ã³ã‚Šæ¸©æ³‰æ—…è¡Œã‚°ãƒ«ãƒ¼ãƒ—", desc: "æ¸…æ½”ãªå®¿ã§ã¾ã£ãŸã‚Šã€‚" }, en: { title: "The Chill Group", desc: "Relaxing with friends." }, world: [{ rec: "ãƒãƒ¯ã‚¤", rec_en: "Hawaii", tag: "Hawaii", lat: 19.8968, lng: -155.5828, desc: "ãƒ¯ã‚¤ã‚­ã‚­ãƒ“ãƒ¼ãƒã®å¤•æ—¥ã€‚" }] }
    };

    let currentQIndex=0; let userAnswers=new Array(questions.length).fill(null);

    // --- Core Logic ---
    function toggleLanguage(){currentLang=currentLang==='ja'?'en':'ja';document.getElementById('lang-btn').innerText=currentLang==='ja'?"ğŸ‡¯ğŸ‡µ JP / ğŸ‡ºğŸ‡¸ EN":"ğŸ‡ºğŸ‡¸ EN / ğŸ‡¯ğŸ‡µ JP";updateUIText();}
    function updateUIText(){
        const t=translations[currentLang];
        document.getElementById('start-title').innerText=t.title;document.getElementById('start-subtitle').innerHTML=t.subtitle;document.getElementById('start-btn-text').innerText=t.startBtn;
        document.getElementById('btn-next').innerText=t.btnNext;document.getElementById('btn-back').innerText=t.btnBack;
        document.getElementById('pre-title').innerText=t.preTitle;document.getElementById('pre-subtitle').innerHTML=t.preSubtitle;document.getElementById('show-result-btn-text').innerText=t.showResultBtn;
        document.getElementById('rec-label').innerText=t.labelRec;
        document.getElementById('opt-world').innerText=t.world;document.getElementById('opt-japan').innerText=t.japan;
        if(!document.getElementById('quiz-screen').classList.contains('hidden'))renderQuestion();
        else if(!document.getElementById('result-screen').classList.contains('hidden')) updateResultUI();
    }
    
    function startQuiz(){document.getElementById('start-screen').classList.add('hidden');document.getElementById('quiz-screen').classList.remove('hidden');renderQuestion();}
    function renderQuestion(){
        const q=questions[currentQIndex];document.getElementById('question-text').innerText=`Q${currentQIndex+1}. ${q[currentLang]}`;
        const pct=(currentQIndex/questions.length)*100;document.getElementById('progress').style.width=`${pct}%`;
        const container=document.getElementById('options-container');container.innerHTML='';
        optionsData.forEach((opt,idx)=>{
            const label=document.createElement('label');label.className='option-label';
            if(userAnswers[currentQIndex]===idx)label.classList.add('selected');
            const radio=document.createElement('input');radio.type='radio';radio.name='q-option';radio.className='option-radio';radio.value=idx;radio.checked=(userAnswers[currentQIndex]===idx);
            radio.onclick=()=>{userAnswers[currentQIndex]=idx;renderQuestion();};
            const span=document.createElement('span');span.innerText=opt[currentLang];label.appendChild(radio);label.appendChild(span);container.appendChild(label);
        });
        document.getElementById('btn-back').style.visibility=(currentQIndex===0)?'hidden':'visible';document.getElementById('btn-next').disabled=(userAnswers[currentQIndex]===null);
    }
    function nextQuestion(){currentQIndex++;if(currentQIndex<questions.length)renderQuestion();else{document.getElementById('quiz-screen').classList.add('hidden');document.getElementById('pre-result-screen').classList.remove('hidden');}}
    function prevQuestion(){if(currentQIndex>0){currentQIndex--;renderQuestion();}}

    // --- Result Calculation ---
    function calcAndShowResults(){
        let scores={mud:0,clean:0,active:0,safe:0,social:0,solo:0,flow:0,order:0};
        userAnswers.forEach((optIdx,qIdx)=>{const q=questions[qIdx];const opt=optionsData[optIdx];if(opt.type==='pos'){for(const[k,v] of Object.entries(q.pos))scores[k]+=v*opt.weight;}else if(opt.type==='neg'){for(const[k,v] of Object.entries(q.neg))scores[k]+=v*opt.weight;}});
        const mbti=document.getElementById('mbti-select').value;
        if(mbti&&mbti.length===4){if(mbti[0]==='E')scores.social+=2;else if(mbti[0]==='I')scores.solo+=2;if(mbti[1]==='S')scores.clean+=2;else if(mbti[1]==='N')scores.mud+=2;if(mbti[3]==='J')scores.order+=2;else if(mbti[3]==='P')scores.flow+=2;}
        const axis1=scores.mud-scores.clean;const axis2=scores.active-scores.safe;const axis3=scores.social-scores.solo;const axis4=scores.flow-scores.order;
        finalId="";finalId+=axis1>0?"æ³¥":"æµ„";finalId+=axis2>0?"æ”»":"å®‰";finalId+=axis3>0?"å…±":"å­¤";finalId+=axis4>0?"éŠ":"å¾‹";
        
        document.getElementById('pre-result-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-image').src=`./images/${finalId}.png`;

        // ã€ä¿®æ­£ã€‘ãƒãƒƒãƒ—åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é…ã‚‰ã›ã¦ã€ç¢ºå®Ÿã«ã‚°ãƒ¬ãƒ¼ç”»é¢ã‚’é˜²ã
        setTimeout(() => {
            initMap();
            updateResultUI();
        }, 500);
    }

    function toggleMapMode() {
        currentMode = currentMode === 'world' ? 'japan' : 'world';
        const switchEl = document.getElementById('mode-switch');
        const optWorld = document.getElementById('opt-world');
        const optJapan = document.getElementById('opt-japan');
        
        if (currentMode === 'japan') {
            switchEl.classList.add('japan-mode');
            optWorld.classList.remove('active');
            optJapan.classList.add('active');
        } else {
            switchEl.classList.remove('japan-mode');
            optWorld.classList.add('active');
            optJapan.classList.remove('active');
        }
        updateResultUI();
    }

    function updateResultUI() {
        if (!resultData[finalId]) finalId = "æµ„å®‰å…±å¾‹"; 
        const basicData = resultData[finalId];
        const basic = basicData[currentLang];
        document.getElementById('result-id').innerText = `ã€${finalId}ã€‘`;
        document.getElementById('result-desc').innerText = basic.title;
        
        let spots = [];
        if (currentMode === 'japan') {
            const cleanFinalId = finalId.trim();
            if (japanDataCache[cleanFinalId] && japanDataCache[cleanFinalId].length > 0) {
                spots = japanDataCache[cleanFinalId];
            } else {
                document.getElementById('rec-content').innerText = "Loading data...";
                return;
            }
        } else {
            spots = basicData.world || [];
        }
        
        if (spots.length > 0) {
            updateInfoBox(spots[0]);
            updateMapPins(spots);
        }
    }

    function updateInfoBox(spot) {
        const name = currentLang === 'ja' ? spot.rec : spot.rec_en;
        currentSpotName = name; // Shareç”¨å¤‰æ•°æ›´æ–°
        document.getElementById('rec-content').innerText = name;
        
        // ã€ä¿®æ­£ã€‘ã‚¿ã‚°ãŒç©ºã®å ´åˆã¯ãƒªãƒ³ã‚¯ã‚’ç„¡åŠ¹åŒ–ã›ãšãƒˆãƒƒãƒ—ã¸ï¼ˆã¾ãŸã¯éè¡¨ç¤ºï¼‰
        const tag = spot.tag ? spot.tag : "";
        document.getElementById('insta-link').href = tag ? `https://www.instagram.com/explore/tags/${tag}/` : "#";
        document.getElementById('insta-link').innerText = `${translations[currentLang].instaBtn} ${tag ? '#'+tag : ''}`;
    }

    function initMap() {
        const container = document.getElementById('map-container');
        container.style.display = 'block';
        
        if(map) { 
            map.invalidateSize(); // ã€é‡è¦ã€‘ãƒªã‚µã‚¤ã‚ºé€šçŸ¥ã§ã‚°ãƒ¬ãƒ¼ç”»é¢é˜²æ­¢
            return; 
        }
        
        map = L.map('map');
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);
    }

    function updateMapPins(spots) {
        if (!map) return;
        map.invalidateSize(); // å¿µã®ãŸã‚ã“ã“ã§ã‚‚å‘¼ã¶
        
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        const bounds = [];
        
        spots.forEach(spot => {
            // ã€ä¿®æ­£ã€‘ã‚¹ãƒãƒƒãƒˆãŒ1ã¤ãªã‚‰setViewã€è¤‡æ•°ãªã‚‰bounds
            if (spots.length === 1) {
                map.setView([spot.lat, spot.lng], spot.zoom || 12);
            }
            
            const marker = L.marker([spot.lat, spot.lng]).addTo(map);
            marker.on('click', () => { updateInfoBox(spot); marker.openPopup(); });
            
            const name = currentLang === 'ja' ? spot.rec : spot.rec_en;
            const desc = spot.desc || "Recommended";
            marker.bindPopup(`<div class="map-card"><h4>${name}</h4><p>${desc}</p></div>`);
            
            markers.push(marker);
            bounds.push([spot.lat, spot.lng]);
        });

        // è¤‡æ•°ã‚¹ãƒãƒƒãƒˆãŒã‚ã‚‹å ´åˆã®ã¿è‡ªå‹•ã‚ºãƒ¼ãƒ 
        if (spots.length > 1 && bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // ã€ä¿®æ­£ã€‘ã‚·ã‚§ã‚¢æ–‡è¨€ã«ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆè¿½åŠ 
    function shareOnX() {
        const text = `My Travel ID: ${finalId}\nRec: ${currentSpotName}\n#TravelID`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
    }
    
    function copyForDiscord() {
        const text = `My Travel ID: ${finalId}\nRecommended: ${currentSpotName}\n${window.location.href}`;
        navigator.clipboard.writeText(text).then(() => alert("Copied for Discord!"));
    }
</script>
</body>
</html>