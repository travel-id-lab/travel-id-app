<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel ID - Value Segmentation</title>
    <link rel="icon" href="./images/logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --primary: #111827; --secondary: #6b7280; --accent: #2563eb; 
            --bg: #f8fafc; --surface: #ffffff; --border: #e2e8f0; 
            --pink: #ff007f; --discord: #5865F2;
            --scale-5: #111827; --scale-4: #4b5563; --scale-3: #9ca3af; --scale-2: #d1d5db; --scale-1: #f3f4f6;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--primary); margin: 0; padding: 0; line-height: 1.6; }
        .container { background: var(--surface); width: 100%; max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* Auth Bar */
        .auth-bar { padding: 12px 20px; background: #f1f5f9; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .auth-status { font-size: 11px; font-weight: 700; color: var(--secondary); }
        .auth-btn { background: var(--primary); color: white; border: none; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; }

        /* Login Modal */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; }

        /* Header */
        .header { padding: 40px 24px 30px; position: relative; }
        .lang-switch { position: absolute; top: 20px; right: 24px; font-size: 11px; font-weight: 800; color: var(--primary); background: white; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; z-index: 40; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .brand-tag { font-size: 11px; font-weight: 800; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; display: block; margin-bottom: 10px; }
        h1 { font-size: 36px; font-weight: 900; margin: 0; line-height: 1.1; letter-spacing: -1px; }
        .hero-sub { font-size: 15px; color: var(--secondary); margin-top: 15px; font-weight: 500; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 30px; display: flex; justify-content: space-between; align-items: center; transition: opacity 0.2s; }
        .btn-primary:active { transform: scale(0.98); }

        /* Quiz UI */
        #quiz-screen, #mbti-screen { padding: 60px 24px; }
        .hidden { display: none !important; }
        .progress-track { height: 6px; background: #f1f5f9; margin-bottom: 20px; border-radius: 3px; overflow: hidden;}
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .q-cat { font-size: 10px; font-weight: 800; color: var(--accent); letter-spacing: 1px; display: block; margin-bottom: 8px;}
        .q-text { font-size: 20px; font-weight: 800; margin-bottom: 30px; min-height: 60px; line-height: 1.4; }
        .opt-btn { width: 100%; padding: 16px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 12px; background: white; text-align: left; font-weight: 600; cursor: pointer; transition: 0.1s; }
        .opt-btn:active { background: #f3f4f6; }
        .opt-5 { border-left: 6px solid var(--scale-5); } .opt-4 { border-left: 4px solid var(--scale-4); } .opt-3 { border-left: 2px solid var(--scale-3); } .opt-2 { border-left: 1px solid var(--scale-2); } .opt-1 { border-left: 1px solid var(--scale-1); }

        /* Result UI */
        #result-screen { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; }
        .res-header { padding: 30px 24px 20px; border-bottom: 1px solid var(--border); text-align: center; }
        .id-kanji { font-size: 48px; font-weight: 900; margin: 5px 0; letter-spacing: 4px; color: var(--primary); }
        .id-title { font-size: 18px; font-weight: 700; color: var(--accent); text-transform: uppercase; margin:0;}
        .id-mbti { font-size: 12px; font-weight: 800; background: #eef2ff; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px; border:1px solid #c7d2fe; }
        .id-desc { font-size: 13px; color: var(--secondary); text-align: left; margin: 15px 0 25px; line-height: 1.6; }
        .tribe-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tribe-btn { padding: 12px; border: 1px solid var(--border); background: white; border-radius: 8px; font-weight: 700; font-size: 11px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; color: var(--primary); text-decoration: none;}
        .tribe-btn.discord { grid-column: span 2; background: var(--discord); color: white; border: none; font-size: 13px; padding: 14px;}

        /* Map & Controls */
        .controls { padding: 10px 24px; display: flex; gap: 8px; border-bottom: 1px solid var(--border); background: white; }
        .ctrl-pill { padding: 6px 14px; border-radius: 20px; border: none; background: #f1f5f9; color: var(--secondary); font-weight: 700; font-size: 12px; cursor: pointer; }
        .ctrl-pill.active { background: var(--primary); color: white; }
        
        #map-container { flex-grow: 1; min-height: 300px; background: #e5e7eb; position: relative; z-index: 1;}
        #map { width: 100%; height: 100%; position: absolute; top:0; left:0; }
        
        /* Spot Card */
        .spot-card { padding: 24px; background: white; border-top: 1px solid var(--border); z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
        .spot-n { margin: 0; font-size: 16px; font-weight: 800; }
        .spot-d { font-size: 12px; color: var(--secondary); margin-bottom: 15px; }
        .actions { display: flex; gap: 10px; }
        .act-btn { flex: 1; padding: 14px; border-radius: 12px; border: 1px solid var(--border); text-align: center; font-weight: 700; cursor: pointer; font-size: 13px; color: var(--primary); display: flex; justify-content: center; align-items: center; gap: 6px; text-decoration: none;}
        .act-save.saved { background: var(--pink); color: white; border-color: var(--pink); animation: pop 0.4s ease; }
        .act-vibe { background: var(--primary); color: white; border-color: var(--primary); }
        .act-vibe.disabled { opacity: 0.5; pointer-events: none; background: #eee; border-color: #eee; color: #999; }
        
        @keyframes pop { 50% { transform: scale(1.1); } }
        
        img.leaflet-marker-icon { transition: all 0.3s; }
        .pin-sys { filter: hue-rotate(140deg) brightness(0.9); }
        .pin-sav { filter: hue-rotate(320deg) saturate(3) brightness(1.2); transform: scale(1.5) translateY(-15px); z-index: 1000 !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="auth-bar">
        <span id="user-display" class="auth-status">Guest Mode</span>
        <button id="auth-action-btn" class="auth-btn" onclick="openLoginModal()">Login to Save</button>
    </div>

    <div id="login-modal" class="hidden">
        <div class="modal-content">
            <h2 style="margin-top:0;">Log in / Sign up</h2>
            <p style="font-size:12px; color:#666; margin-bottom:15px;">Enter email to receive a magic link.</p>
            <input type="email" id="email-input" class="modal-input" placeholder="your@email.com">
            <button class="btn-primary" onclick="handleLogin()" style="margin-top:10px;">Send Magic Link</button>
            <button onclick="closeLoginModal()" style="background:none; border:none; color:#999; margin-top:20px; cursor:pointer; text-decoration:underline;">Cancel</button>
        </div>
    </div>

    <section id="start-screen" class="header">
        <button class="lang-switch" onclick="toggleLang()" id="lang-btn">EN / JP</button>
        <span class="brand-tag">Travel ID</span>
        <h1 id="t-head">Decode Your<br>Travel DNA.</h1>
        <p class="hero-sub" id="t-sub">We don't match you by demographics.<br>We match you by values.</p>
        <button class="btn-primary" onclick="startQuiz()">
            <span id="t-start">Analyze My Style</span> <span>‚Üí</span>
        </button>
        <div style="margin-top:40px; border-top:1px solid #f1f5f9; padding-top:20px;">
            <p style="font-size:11px; color:#9ca3af; line-height:1.5;">v35.0 (Final Polish)</p>
        </div>
    </section>

    <section id="quiz-screen" class="hidden">
        <div class="progress-track"><div id="progress" class="progress-bar"></div></div>
        <span id="q-cat" class="q-cat">CATEGORY</span>
        <h2 id="q-text" class="q-text">Loading...</h2>
        <div id="options-box"></div>
        <div style="margin-top:30px; text-align:center;">
            <button onclick="prevQ()" style="background:none; border:none; color:#9ca3af; font-size:12px; cursor:pointer; text-decoration:underline;">Back</button>
        </div>
    </section>

    <section id="mbti-screen" class="hidden">
        <h2 style="font-size:24px; font-weight:900; margin-bottom:20px;">One last thing...</h2>
        <p style="margin-bottom:20px; font-size:14px; color:#666;">What is your MBTI?</p>
        <select id="mbti-select" style="width:100%; padding:16px; border-radius:12px; border:2px solid #e2e8f0; font-size:16px; font-weight:700; margin-bottom:20px; background:white;">
            <option value="" disabled selected>Select MBTI</option>
            <option value="INTJ">INTJ</option><option value="INTP">INTP</option><option value="ENTJ">ENTJ</option><option value="ENTP">ENTP</option>
            <option value="INFJ">INFJ</option><option value="INFP">INFP</option><option value="ENFJ">ENFJ</option><option value="ENFP">ENFP</option>
            <option value="ISTJ">ISTJ</option><option value="ISFJ">ISFJ</option><option value="ESTJ">ESTJ</option><option value="ESFJ">ESFJ</option>
            <option value="ISTP">ISTP</option><option value="ISFP">ISFP</option><option value="ESTP">ESTP</option><option value="ESFP">ESFP</option>
            <option value="UNKNOWN">I don't know</option>
        </select>
        <button class="btn-primary" onclick="submitMBTI()">
            <span>See Results</span> <span>‚Üí</span>
        </button>
    </section>

    <section id="result-screen" class="hidden">
        <div class="res-header">
            <span class="brand-tag">YOUR SEGMENT</span>
            <div id="res-kanji" class="id-kanji">„Äê „Äë</div>
            <h2 id="res-id" class="id-title">LOADING</h2>
            <div id="res-mbti" class="id-mbti">MBTI</div>
            <div id="img-container" style="max-width:200px; margin:0 auto 15px; border-radius:12px; overflow:hidden; display:none;">
                <img id="type-image" style="width:100%; display:block;" src="" onerror="this.parentElement.style.display='none'">
            </div>
            <p id="res-desc" class="id-desc">Analysis complete.</p>
            <div class="tribe-actions">
                <button class="tribe-btn discord" onclick="copyDiscordProfile()">üìã Copy Profile for Discord</button>
                <a href="https://forms.gle/5L7ndRzgPnh45Mor8" target="_blank" class="tribe-btn">‚ö° Submit Spot</a>
                <button class="tribe-btn" onclick="shareTwitter()">ùïè Share</button>
            </div>
        </div>

        <div class="controls">
            <button id="opt-japan" class="ctrl-pill active" onclick="setMode('japan')">Japan</button>
            <button id="opt-world" class="ctrl-pill" onclick="setMode('world')">Global</button>
            <button class="ctrl-pill" style="margin-left:auto;" onclick="shareUrl()">üîó Copy URL</button>
        </div>

        <div id="map-container"><div id="map"></div></div>

        <div class="spot-card">
            <h3 id="spot-name" class="spot-n">Map Loading...</h3>
            <p id="spot-desc" class="spot-d">Select a pin to reveal spots.</p>
            <div class="actions">
                <button id="btn-save" class="act-btn act-save" onclick="toggleSave()">‚ô° Save</button>
                <a id="btn-insta" href="javascript:void(0)" target="_blank" class="act-btn act-vibe disabled">‚ñ∂ Vibe</a>
            </div>
        </div>
    </section>
</div>

<script>
    // ==========================================
    // ‚òÖ SUPABASE CONFIG ‚òÖ
    // ==========================================
    const SUPABASE_URL = 'https://zqghkzukkzmpszdxyqgf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxZ2hrenVra3ptcHN6ZHh5cWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxNzg2NDYsImV4cCI6MjA4NDc1NDY0Nn0.2-ng4M5LLMkTcQp5pqzg8INEQbDef1HQS4zxFWg_DXg';
    // ==========================================

    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRrOI46FP-ueet2ZD0xKG0r1_xFng90_PDr1Z-sm6OB5xe3I8m0nx5Q5aNIVxvRVi1QLczBbv4pdnAv/pub?output=csv';
    
    // Prevent variable collision
    const travelSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let state = { lang: 'en', mode: 'japan', finalId: "", mbti: "", map: null, markers: [], data: {}, saved: new Set(), qIdx: 0, scores: {mud:0, clean:0, flow:0, order:0, active:0, safe:0, solo:0, social:0}, user: null, curSpot: null };

    // Questions
    const Q = [
        { cat: "ENVIRONMENT", ja: "Áµ∂ÊôØ„ÅåË¶ã„Çâ„Çå„Çã„Å™„Çâ„ÄÅ‰∏çË°õÁîü„Å™Â∞èÂ±ã„Å´Ê≥ä„Åæ„Çã„Åì„Å®„ÇÇÂé≠„Çè„Å™„ÅÑ„ÄÇ", en: "I would stay in a dirty hut if it meant seeing a spectacular view.", pos:{mud:2}, neg:{clean:2} },
        { cat: "CONSUMPTION", ja: "„É™„Çπ„ÇØ„Åå„ÅÇ„Å£„Å¶„ÇÇ„ÄÅÂæó‰Ωì„ÅÆÁü•„Çå„Å™„ÅÑÁèæÂú∞„ÅÆÂ±ãÂè∞ÊñôÁêÜ„ÇíÈ£ü„Åπ„Å¶„Åø„Åü„ÅÑ„ÄÇ", en: "I am willing to eat mysterious local street food despite the risks.", pos:{mud:2}, neg:{clean:2} },
        { cat: "ISOLATION", ja: "ÊñáÊòé„Åã„ÇâÂàáÊñ≠„Åï„Çå„Åü‰∏ç‰æø„Å™Â†¥ÊâÄ„ÅØ„ÄÅÁßÅ„Å´„Å®„Å£„Å¶Ëã¶Áóõ„Åß„ÅØ„Å™„Åè„ÄåËß£Êîæ„Äç„Å†„ÄÇ", en: "Being cut off from civilization feels more like 'freedom' than 'pain'.", pos:{mud:1,solo:1}, neg:{clean:1,social:1} },
        { cat: "UNCERTAINTY", ja: "Âú∞Âõ≥„ÇíÊåÅ„Åü„Åö„Å´Ëø∑Â≠ê„Å´„Å™„Çã„Åì„Å®„ÅØ„ÄÅ„Çπ„Éà„É¨„Çπ„Åß„ÅØ„Å™„Åè„ÄåÂñú„Å≥„Äç„Å†„ÄÇ", en: "Getting lost without a map is a joy, not a stress.", pos:{flow:2}, neg:{order:2} },
        { cat: "CONTROL", ja: "ÂàÜÂçò‰Ωç„ÅßÂÆåÁíß„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåÊ±∫„Åæ„Å£„Å¶„ÅÑ„Çã„Å®„ÄÅÂÆâÂøÉ„Åô„Çã„ÄÇ", en: "I feel safe when my schedule is planned down to the minute.", pos:{order:2}, neg:{flow:2} },
        { cat: "ADAPTABILITY", ja: "ÊóÖ„ÅÆ„Éà„É©„Éñ„É´„ÅØ„Äå„Ç®„É©„Éº„Äç„Åß„ÅØ„Å™„Åè„Äå„Éâ„É©„Éû„Äç„Å†„Å®ÊÄù„ÅÜ„ÄÇ", en: "Travel troubles are 'drama' to be enjoyed, not 'errors' to be fixed.", pos:{flow:2}, neg:{order:2} },
        { cat: "INTENSITY", ja: "ÊóÖ„ÅÆÁõÆÁöÑ„ÅØ„ÄåÁôí„ÇÑ„Åó„Äç„Çà„Çä„ÇÇ„ÄåÊ∂àËÄóÔºàÂÖ®Âäõ„ÇíÂá∫„ÅóÂàá„Çã„Åì„Å®Ôºâ„Äç„Å†„ÄÇ", en: "The goal of travel is exhaustion (giving my all) rather than healing.", pos:{active:2}, neg:{safe:2} },
        { cat: "RISK", ja: "Ê≤ªÂÆâ„ÅÆÊÇ™„ÅÑ„Çπ„É©„É†Ë°ó„Çí„ÄÅÂÆâÂÖ®„Å™„Éê„Çπ„Åã„ÇâË¶ã„Çã„Çà„ÇäÈôç„Çä„Å¶Ê≠©„Åç„Åü„ÅÑ„ÄÇ", en: "I'd rather walk through a gritty slum than watch it from a safe bus.", pos:{active:2}, neg:{safe:2} },
        { cat: "INVESTMENT", ja: "‰∫àÁÆó„Çí‰Ωø„ÅÜ„Å™„Çâ„ÄåÊ•µ‰∏ä„ÅÆÂÆâÊÅØ„Äç„Çà„Çä„ÄåÊ•µÈôê„ÅÆ‰ΩìÈ®ì„Äç„Å´‰Ωø„ÅÑ„Åü„ÅÑ„ÄÇ", en: "I'd invest in an 'extreme experience' rather than 'luxury rest'.", pos:{active:2}, neg:{safe:2} },
        { cat: "SOLITUDE", ja: "Â§ßËá™ÁÑ∂„ÅÆ‰∏≠„Åß‰∏Ä‰∫∫„Åß„ÅÑ„ÇãÊôÇ„ÄÅÂØÇ„Åó„Åï„Çà„Çä„ÇÇÂÖ®ËÉΩÊÑü„ÇíÊÑü„Åò„Çã„ÄÇ", en: "Alone in nature, I feel empowerment rather than loneliness.", pos:{solo:2}, neg:{social:2} },
        { cat: "CONNECTION", ja: "Ë®ÄËëâ„ÅåÈÄö„Åò„Å™„Åè„Å¶„ÇÇ„ÄÅÁèæÂú∞„ÅÆ‰∫∫„ÅÆ‰∏≠„Å´È£õ„Å≥Ëæº„Çì„Åß‰∫§ÊµÅ„Åó„Åü„ÅÑ„ÄÇ", en: "I want to dive in and interact with locals even if we don't speak the same language.", pos:{social:2}, neg:{solo:2} },
        { cat: "PARTNER", ja: "ÊóÖ„ÅÆ„Éë„Éº„Éà„Éä„Éº„ÅØ„ÄÅÂæìÈ†Ü„Å™‰∫∫„Çà„Çä„ÄåÁßÅ„ÇíÊåØ„ÇäÂõû„Åô„ÇØ„É¨„Ç§„Ç∏„Éº„Å™‰∫∫„Äç„Åå„ÅÑ„ÅÑ„ÄÇ", en: "I prefer a crazy partner who drags me around over an obedient one.", pos:{social:1,flow:1}, neg:{solo:1,order:1} },
        { cat: "CORE", ja: "ÁßÅ„Å´„Å®„Å£„Å¶ÊóÖ„Å®„ÅØ„ÄåÊó•Â∏∏„ÅÆÂõûÂæ©„Äç„Åß„ÅØ„Å™„Åè„Äå‰æ°ÂÄ§Ë¶≥„ÅÆÁ†¥Â£ä„Äç„Å†„ÄÇ", en: "To me, travel is about destroying values, not restoring daily life.", pos:{active:2,mud:1}, neg:{safe:2,clean:1} }
    ];

    const T = {
        en: { 
            head: "Decode Your\nTravel DNA.", sub: "We don't match you by demographics.\nWe match you by values.", start: "Analyze My Style", save: "Save", saved: "Saved!", vibe: "View Vibe", world: "Global", japan: "Domestic", discord: "Copy Profile for Discord", submit: "Submit Spot",
            types: {
                "Ê≥•ÊîªÂ≠§ÈÅä": { t: "The Unfiltered Explorer", d: "Raw √ó Intense √ó Solo √ó Spontaneous.\nA nomad who seeks truth over comfort. You find beauty in the chaos that others reject." },
                "ÊµÑÂÆâÂÖ±Âæã": { t: "The Aesthetic Planner", d: "Refined √ó Gentle √ó Social √ó Structured.\nA guardian of beauty. You curate perfect harmony and reject the noise of the world." },
                "Ê≥•ÂÆâÂÖ±ÈÅä": { t: "The Immersion Seeker", d: "Raw √ó Gentle √ó Social √ó Spontaneous.\nA connector of souls. You dive into local life with an open heart and zero judgement." },
                "ÊµÑÊîªÂ≠§Âæã": { t: "The Noble Sniper", d: "Refined √ó Intense √ó Solo √ó Structured.\nA stoic perfectionist. You don't tour; you hunt for the sublime moment in solitude." },
                "fallback": { t: "The Unique Voyager", d: "Your value map is unique. Explore the map to find your tribe." }
            }
        },
        ja: {
            head: "ÊóÖ„ÅÆDNA„Çí\nËß£Ë™≠„Åô„Çã„ÄÇ", sub: "Â±ûÊÄß„Åß„ÅØ„Å™„Åè„ÄÅ\n„Äå‰æ°ÂÄ§Ë¶≥„Äç„Åß‰∏ñÁïå„ÇíÂÜçÂÆöÁæ©„Åô„Çã„ÄÇ", start: "„Çπ„Çø„Ç§„É´„ÇíÂàÜÊûê", save: "‰øùÂ≠ò", saved: "‰øùÂ≠òÂÆå‰∫Ü", vibe: "ÂãïÁîª„ÇíË¶ã„Çã", world: "‰∏ñÁïå", japan: "Êó•Êú¨", discord: "DiscordÁî®„Éó„É≠„Éï„Çí„Ç≥„Éî„Éº", submit: "ËÅñÂú∞„Çí„Çø„É¨„Åì„ÇÄ",
            types: {
                "Ê≥•ÊîªÂ≠§ÈÅä": { t: "The Unfiltered Explorer", d: "„ÄêRaw √ó Intense √ó Solo √ó Spontaneous„Äë\nÈ£æ„Çâ„Å™„ÅÑÊé¢Á©∂ËÄÖ„ÄÇÂÆâÂÖ®„Å™È£ºËÇ≤Â∞èÂ±ã„Çà„Çä„ÄÅÂÇ∑„Å†„Çâ„Åë„ÅÆËçíÈáé„ÇíÈÅ∏„Å∂„ÄÇ„Ç´„Ç™„Çπ„ÅÆ‰∏≠„Å´„Åì„Åù„ÄåÁîü„Äç„Åå„ÅÇ„Çã„ÄÇ" },
                "ÊµÑÂÆâÂÖ±Âæã": { t: "The Aesthetic Planner", d: "„ÄêRefined √ó Gentle √ó Social √ó Structured„Äë\nÁæéÂ≠¶„ÅÇ„ÇãË®àÁîªËÄÖ„ÄÇ„Éé„Ç§„Ç∫„ÇíÂæπÂ∫ï„Åó„Å¶ÊéíÈô§„Åó„ÄÅÂú∞‰∏ä„Å´ÂÆåÁíß„Å™Ê•ΩÂúíÔºà„Çµ„É≥„ÇØ„ÉÅ„É•„Ç¢„É™Ôºâ„ÇíË®≠Ë®à„Åô„Çã„ÄÇ" },
                "Ê≥•ÂÆâÂÖ±ÈÅä": { t: "The Immersion Seeker", d: "„ÄêRaw √ó Gentle √ó Social √ó Spontaneous„Äë\nÊ≤°ÂÖ•„Åô„Çã‰∫∫„ÄÇÊ∏ÖÊøÅ‰Ωµ„ÅõÂëë„ÇÄÊúÄÂº∑„ÅÆÂÖçÁñ´Âäõ„Åß„ÄÅ„Å©„Çì„Å™Ë∑ØÂú∞Ë£è„Å´„ÇÇ„ÄåÊÑõ„Äç„ÇíË¶ã„Å§„ÅëÂá∫„Åô„ÄÇ" },
                "ÊµÑÊîªÂ≠§Âæã": { t: "The Noble Sniper", d: "„ÄêRefined √ó Intense √ó Solo √ó Structured„Äë\nÂ≠§È´ò„ÅÆÁãôÊíÉÊâã„ÄÇÂ¶•Âçî„Å™„ÅçÁæéÊÑèË≠ò„ÄÇ„ÅÇ„Å™„Åü„Åå„Åô„Çã„ÅÆ„ÅØË¶≥ÂÖâ„Åß„ÅØ„Å™„ÅÑ„ÄÅÁæé„ÇíÊíÉ„Å°Êäú„Åè„ÄåÁã©„Çä„Äç„Å†„ÄÇ" },
                "fallback": { t: "The Unique Voyager", d: "Áã¨Ëá™„ÅÆÊóÖ„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éû„ÉÉ„Éó„ÇíÊé¢Á¥¢„Åó„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Éà„É©„Ç§„ÉâÔºàÈÉ®ÊóèÔºâ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ" }
            }
        }
    };

    // --- AUTH LOGIC ---
    async function checkUser() {
        const { data: { session } } = await travelSupabase.auth.getSession();
        if (session) {
            state.user = session.user;
            updateAuthUI();
            await loadProfile(); 
        }
    }

    async function handleLogin() {
        const email = document.getElementById('email-input').value;
        if (!email) return alert("Enter email");
        const { error } = await travelSupabase.auth.signInWithOtp({ email });
        if (error) alert("Error: " + error.message);
        else alert("Magic Link sent! Check your email to login.");
        closeLoginModal();
    }

    async function handleLogout() {
        await travelSupabase.auth.signOut();
        location.reload();
    }

    function updateAuthUI() {
        const d = document.getElementById('user-display');
        const b = document.getElementById('auth-action-btn');
        if (state.user) {
            d.innerText = "Logged in";
            b.innerText = "Logout";
            b.onclick = handleLogout;
        }
    }

    async function saveProfile() {
        if (!state.user) return;
        const updates = {
            id: state.user.id,
            updated_at: new Date(),
            saved_spots: Array.from(state.saved),
            final_id: state.finalId,
            mbti: state.mbti
        };
        await travelSupabase.from('profiles').upsert(updates);
    }

    async function loadProfile() {
        if (!state.user) return;
        const { data } = await travelSupabase.from('profiles').select('*').eq('id', state.user.id).single();
        if (data && data.saved_spots) {
            state.saved = new Set(data.saved_spots);
            if (state.map) updateMap();
        }
    }

    // --- APP LOGIC ---
    document.addEventListener('DOMContentLoaded', () => { init(); });

    function init(){
        checkUser(); 
        const localSaved = JSON.parse(localStorage.getItem('tid_saved') || '[]');
        if(!state.user && localSaved.length > 0) state.saved = new Set(localSaved);

        const urlParams = new URLSearchParams(window.location.search);
        const sharedId = urlParams.get('id');

        fetchData(() => {
            if(sharedId) {
                state.finalId = sharedId;
                showResultScreen();
            } else {
                updateUIText();
            }
        });
    }

    function fetchData(cb) {
        Papa.parse(CSV_URL, { download: true, header: true, skipEmptyLines: true, complete: res => {
            res.data.forEach(r => {
                if(r.id){
                    const k = r.id.trim();
                    if(!state.data[k]) state.data[k] = [];
                    state.data[k].push({
                        uid: r.uid || Math.random().toString(),
                        name_jp: r.rec_jp, name_en: r.rec_en, desc: r.desc, tag: r.tag,
                        lat: parseFloat(r.lat), lng: parseFloat(r.lng), zoom: parseInt(r.zoom)||12, region: r.region?r.region.trim():'japan'
                    });
                }
            });
            if(cb) cb();
        }});
    }

    function startQuiz(){ document.getElementById('start-screen').classList.add('hidden'); document.getElementById('quiz-screen').classList.remove('hidden'); renderQ(); }
    
    function renderQ(){
        if(state.qIdx >= Q.length){ document.getElementById('quiz-screen').classList.add('hidden'); document.getElementById('mbti-screen').classList.remove('hidden'); return; }
        const q = Q[state.qIdx];
        document.getElementById('q-cat').innerText = q.cat;
        document.getElementById('q-text').innerText = state.lang==='ja' ? q.ja : q.en;
        document.getElementById('progress').style.width = `${((state.qIdx)/Q.length)*100}%`;
        const box = document.getElementById('options-box'); box.innerHTML='';
        const opts = [{l:state.lang==='ja'?"Âº∑„Åè„Åù„ÅÜÊÄù„ÅÜ":"Strongly Agree", w:2, c:"opt-5"}, {l:state.lang==='ja'?"„Åù„ÅÜÊÄù„ÅÜ":"Agree", w:1, c:"opt-4"}, {l:state.lang==='ja'?"„Å©„Å°„Çâ„Åß„ÇÇ„Å™„ÅÑ":"Neutral", w:0, c:"opt-3"}, {l:state.lang==='ja'?"„Åù„ÅÜÊÄù„Çè„Å™„ÅÑ":"Disagree", w:-1, c:"opt-2"}, {l:state.lang==='ja'?"ÂÖ®„Åè„Åù„ÅÜÊÄù„Çè„Å™„ÅÑ":"Strongly Disagree", w:-2, c:"opt-1"}];
        opts.forEach(o=>{
            const b = document.createElement('div'); b.className = `opt-btn ${o.c}`; b.innerHTML=o.l;
            b.onclick = ()=>{ 
                if(o.w>0) Object.keys(q.pos).forEach(k=>state.scores[k]+=q.pos[k]*o.w);
                if(o.w<0) Object.keys(q.neg).forEach(k=>state.scores[k]+=q.neg[k]*Math.abs(o.w));
                state.qIdx++; renderQ();
            };
            box.appendChild(b);
        });
    }

    function prevQ(){ if(state.qIdx > 0){ state.qIdx--; renderQ(); } else { location.reload(); } }

    function submitMBTI(){
        state.mbti = document.getElementById('mbti-select').value;
        if(!state.mbti) return alert("Select MBTI");
        if(state.mbti.includes('E')) state.scores.social += 2;
        if(state.mbti.includes('I')) state.scores.solo += 2;
        if(state.mbti.includes('J')) state.scores.order += 2;
        if(state.mbti.includes('P')) state.scores.flow += 2;
        
        const axis1 = state.scores.mud >= state.scores.clean ? "Ê≥•" : "ÊµÑ";
        const axis2 = state.scores.active >= state.scores.safe ? "Êîª" : "ÂÆâ";
        const axis3 = state.scores.social >= state.scores.solo ? "ÂÖ±" : "Â≠§";
        const axis4 = state.scores.flow >= state.scores.order ? "ÈÅä" : "Âæã";
        state.finalId = axis1+axis2+axis3+axis4;
        
        document.getElementById('mbti-screen').classList.add('hidden');
        showResultScreen();
        saveProfile();
    }

    function showResultScreen(){
        document.getElementById('result-screen').classList.remove('hidden');
        updateResultUI();
        // ‚òÖ CRITICAL FIX: Ensure map resizes AFTER transition
        setTimeout(()=>{ if(!state.map) initMap(); else state.map.invalidateSize(); updateMap(); }, 300);
    }

    function updateResultUI(){
        document.getElementById('res-kanji').innerText = `„Äê ${state.finalId} „Äë`;
        document.getElementById('res-mbti').innerText = `MBTI: ${state.mbti}`;
        
        const img = document.getElementById('type-image');
        img.src = `./images/${state.finalId}.png`;
        img.onload = ()=>document.getElementById('img-container').style.display='block';

        let tData = T[state.lang].types[state.finalId];
        if(!tData) {
            if(state.finalId.includes("Ê≥•") && state.finalId.includes("Êîª")) tData = T[state.lang].types["Ê≥•ÊîªÂ≠§ÈÅä"];
            else if(state.finalId.includes("ÊµÑ") && state.finalId.includes("ÂÆâ")) tData = T[state.lang].types["ÊµÑÂÆâÂÖ±Âæã"];
            else if(state.finalId.includes("Ê≥•") && state.finalId.includes("ÂÖ±")) tData = T[state.lang].types["Ê≥•ÂÆâÂÖ±ÈÅä"];
            else if(state.finalId.includes("ÊµÑ") && state.finalId.includes("Êîª")) tData = T[state.lang].types["ÊµÑÊîªÂ≠§Âæã"];
            else tData = T[state.lang].types["fallback"];
        }
        document.getElementById('res-id').innerText = tData.t;
        document.getElementById('res-desc').innerText = tData.d;
        
        const t = T[state.lang];
        document.getElementById('t-head').innerHTML = t.head.replace('\n', '<br>');
        document.getElementById('t-sub').innerHTML = t.sub.replace('\n', '<br>');
        document.getElementById('t-start').innerText = t.start;
        document.querySelector('.tribe-btn.discord span:last-child').innerText = t.discord;
        document.querySelector('a[href*="forms"]').innerText = "‚ö° " + t.submit;
        document.getElementById('opt-world').innerText = t.world;
        document.getElementById('opt-japan').innerText = t.japan;
        document.getElementById('btn-save').innerHTML = state.saved.has(state.curSpot?.uid) ? '‚ô• Saved' : '‚ô° ' + t.save;
        document.getElementById('btn-insta').innerText = '‚ñ∂ ' + t.vibe;
        
        if(state.map) updateMap();
    }

    function toggleLang(){
        state.lang = state.lang==='en'?'ja':'en';
        document.getElementById('lang-btn').innerText = state.lang==='en'?"EN / JP":"JP / EN";
        if(state.finalId) updateResultUI(); else {
            const t = T[state.lang];
            document.getElementById('t-head').innerHTML = t.head.replace('\n', '<br>');
            document.getElementById('t-sub').innerHTML = t.sub.replace('\n', '<br>');
            document.getElementById('t-start').innerText = t.start;
            if(state.qIdx>0) renderQ();
        }
    }
    
    function updateUIText(){
        const t = T[state.lang];
        document.getElementById('t-head').innerHTML = t.head.replace('\n', '<br>');
        document.getElementById('t-sub').innerHTML = t.sub.replace('\n', '<br>');
        document.getElementById('t-start').innerText = t.start;
    }

    // Map
    function initMap(){
        state.map = L.map('map');
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {attribution:'&copy; CARTO', maxZoom:19}).addTo(state.map);
    }

    function updateMap(){
        if(!state.map) return;
        state.map.eachLayer(l => { if(l instanceof L.Marker) state.map.removeLayer(l); });
        
        let raw = state.data[state.finalId] || [];
        if(raw.length===0) {
             const keys = Object.keys(state.data);
             for(let k of keys){ if(state.finalId.includes(k.substring(0,2))) { raw = state.data[k]; break; } }
             if(raw.length===0) raw = Object.values(state.data).flat();
        }
        let spots = state.mode==='japan' ? raw.filter(s=>s.region==='japan') : raw.filter(s=>s.region==='world');
        
        if(spots.length===0) { state.map.setView([35,135], 5); return; }
        
        const bounds = [];
        spots.forEach(s=>{
            const isSaved = state.saved.has(s.uid);
            const icon = L.divIcon({className:'', html:`<img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="leaflet-marker-icon ${isSaved?'pin-sav':'pin-sys'}" style="margin-left:-12px; margin-top:-41px;">`});
            const m = L.marker([s.lat, s.lng], {icon:icon}).addTo(state.map);
            m.on('click', ()=>showSpot(s));
            bounds.push([s.lat, s.lng]);
        });
        state.map.fitBounds(bounds, {padding:[50,50]});
        
        // ‚òÖ AUTO SELECT FIRST SPOT ‚òÖ
        if(spots.length > 0) showSpot(spots[0]);
    }

    function showSpot(s){
        state.curSpot = s;
        document.getElementById('spot-name').innerText = state.lang==='ja'?s.name_jp:s.name_en;
        document.getElementById('spot-desc').innerText = s.desc || "Recommended";
        const btn = document.getElementById('btn-insta');
        // Enable/Disable Vibe Button
        if(s.tag){ 
            btn.href=`https://www.instagram.com/explore/tags/${s.tag}/`; 
            btn.classList.remove('disabled');
        } else { 
            btn.href="javascript:void(0)"; 
            btn.classList.add('disabled');
        }
        updateSaveBtn();
    }

    function toggleSave(){
        if(!state.curSpot) return;
        const k = state.curSpot.uid;
        if(state.saved.has(k)) state.saved.delete(k); else state.saved.add(k);
        localStorage.setItem('tid_saved', JSON.stringify([...state.saved]));
        saveProfile();
        updateSaveBtn();
        updateMap();
    }

    function updateSaveBtn(){
        if(!state.curSpot) return;
        const saved = state.saved.has(state.curSpot.uid);
        const btn = document.getElementById('btn-save');
        const t = T[state.lang];
        if(saved) { btn.classList.add('saved'); btn.innerHTML = '‚ô• ' + t.saved; }
        else { btn.classList.remove('saved'); btn.innerHTML = '‚ô° ' + t.save; }
    }

    // Modal & Shares
    function openLoginModal(){ document.getElementById('login-modal').classList.remove('hidden'); }
    function closeLoginModal(){ document.getElementById('login-modal').classList.add('hidden'); }
    
    function copyDiscordProfile() {
        const tData = T[state.lang].types[state.finalId] || T[state.lang].types["fallback"];
        let recSpot = "Not selected";
        if(state.data[state.finalId] && state.data[state.finalId].length > 0) recSpot = state.data[state.finalId][0].name_jp;
        const text = `**„Äê${state.finalId}„Äë (${tData.t})**\n**MBTI: ${state.mbti}**\n${tData.d}\n\nüìç Recommended: ${recSpot}\n#TravelID\n${window.location.href}`;
        navigator.clipboard.writeText(text).then(() => alert("Profile copied!"));
    }
    function shareUrl() {
        const url = `${window.location.origin}${window.location.pathname}?id=${state.finalId}`;
        navigator.clipboard.writeText(url).then(() => alert("URL Copied!"));
    }
    function shareTwitter() {
        const tData = T[state.lang].types[state.finalId] || T[state.lang].types["fallback"];
        const text = `I am "${tData.t}" (${state.mbti}). My Travel ID is „Äê${state.finalId}„Äë. #TravelID`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`, '_blank');
    }
    function setMode(m){ state.mode=m; document.getElementById('opt-japan').classList.toggle('active', m==='japan'); document.getElementById('opt-world').classList.toggle('active', m==='world'); updateMap(); }

</script>
</body>
</html>