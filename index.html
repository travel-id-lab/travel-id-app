<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel ID - Value Segmentation</title>
    <link rel="icon" href="./images/logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root{
            --primary: #111827; 
            --secondary: #6b7280; 
            --accent: #2563eb; 
            --bg: #f8fafc;
            --border: #e2e8f0;
            --pink: #ff007f; /* Neon Pink for Save */
            --green: #10b981; 
            --scale-5: #111827; --scale-4: #4b5563; --scale-3: #9ca3af; --scale-2: #d1d5db; --scale-1: #f3f4f6;
            --discord: #5865F2;
        }
        body{font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color:var(--bg); color:var(--primary); margin:0; padding:0; line-height:1.6;}
        .container{background:#ffffff; width:100%; max-width:480px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; box-shadow: 0 0 20px rgba(0,0,0,0.05); position:relative;}
        
        /* Language Toggle */
        .lang-switch { 
            position: absolute; top: 20px; right: 20px; 
            font-size: 11px; font-weight: 800; color: var(--primary); 
            cursor: pointer; z-index: 9999; background: white;
            padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Typography */
        .header { padding: 60px 24px 40px; }
        .brand-tag { font-size: 11px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); display:block; margin-bottom: 12px;}
        h1 { font-size: 38px; font-weight: 900; margin: 0; letter-spacing: -1.5px; line-height: 1.1; color: var(--primary); }
        .hero-sub { font-size: 15px; color: var(--secondary); margin-top: 16px; font-weight: 500; }

        /* Buttons */
        .btn-primary {
            background: var(--primary); color: white; border: none; font-size: 16px; padding: 18px; width: 100%; 
            border-radius: 12px; font-weight: 700; cursor: pointer; transition: transform 0.1s; margin-top: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* Quiz UI */
        #quiz-screen { padding: 80px 24px 40px; }
        .progress-track { height: 6px; background: #f1f5f9; margin-bottom: 30px; border-radius: 3px; overflow:hidden;}
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .q-cat { font-size: 10px; font-weight: 800; color: var(--accent); letter-spacing: 1px; margin-bottom: 8px; display: block; text-transform: uppercase;}
        .q-text { font-size: 20px; font-weight: 800; margin-bottom: 30px; min-height: 80px; line-height: 1.4; letter-spacing: -0.5px;}
        
        .opt-btn {
            display: flex; align-items: center; width: 100%; padding: 14px 16px; margin-bottom: 8px;
            border: 1px solid var(--border); border-radius: 12px; background: white;
            text-align: left; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.1s;
        }
        .opt-5 { border-left: 6px solid var(--scale-5); }
        .opt-4 { border-left: 4px solid var(--scale-4); }
        .opt-3 { border-left: 2px solid var(--scale-3); color: var(--secondary); }
        .opt-2 { border-left: 1px solid var(--scale-2); color: var(--secondary); }
        .opt-1 { border-left: 1px solid var(--scale-1); color: #9ca3af; background: #f9fafb; }

        /* Result Dashboard */
        #result-screen { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; }
        
        .res-header { padding: 40px 24px 20px; background: white; border-bottom: 1px solid var(--border); flex-shrink: 0; text-align: center;}
        
        /* ‚òÖ KANJI ID (Big & Impactful) ‚òÖ */
        .id-kanji {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 52px; font-weight: 900; color: var(--primary);
            margin: 10px 0 5px; letter-spacing: 2px; line-height: 1.2;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }

        /* Type Image */
        .type-img-container {
            width: 100%; max-width: 240px; margin: 10px auto 20px;
            border-radius: 16px; overflow: hidden; display: none; /* Hidden until loaded */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .type-img { width: 100%; height: auto; display: block; }

        .id-title { font-size: 18px; font-weight: 700; margin: 0 0 10px; color: var(--accent); letter-spacing: 0px; text-transform: uppercase;}
        .id-desc { font-size: 13px; color: var(--secondary); line-height: 1.6; margin-bottom: 20px; text-align: left;}
        
        /* Action Buttons */
        .tribe-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .tribe-btn { 
            font-size: 11px; padding: 12px; border-radius: 8px; background: white; 
            color: var(--primary); text-align: center; text-decoration: none; 
            border: 1px solid var(--border); font-weight: 700; 
            display:flex; align-items:center; justify-content:center; gap:6px; cursor: pointer;
        }
        /* Discord Button Style */
        .tribe-btn.discord { 
            background: #5865F2; color: white; border:none; 
            grid-column: span 2; /* Full width */
            font-size: 13px; padding: 14px;
        }
        .tribe-btn:active { transform: scale(0.98); }

        /* Map Controls */
        .controls { display: flex; padding: 10px 24px; gap: 8px; background: white; border-bottom: 1px solid var(--border); flex-shrink: 0;}
        .ctrl-pill { padding: 6px 14px; font-size: 12px; font-weight: 700; border-radius: 20px; cursor: pointer; background: #f1f5f9; color: var(--secondary); }
        .ctrl-pill.active { background: var(--primary); color: white; }
        .ctrl-share { margin-left: auto; display:flex; gap:5px;}
        
        /* Map Area */
        #map-container { flex-grow: 1; background: #e5e7eb; position: relative; z-index: 1; width: 100%; height: 100%; min-height: 300px;}
        #map { width: 100%; height: 100%; }

        /* Bottom Sheet */
        .spot-card {
            background: white; border-top: 1px solid var(--border); padding: 24px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.1); z-index: 999; flex-shrink: 0;
        }
        .spot-n { font-size: 16px; font-weight: 800; margin: 0; }
        .spot-d { font-size: 12px; color: var(--secondary); margin-bottom: 15px; }
        .actions { display: flex; gap: 10px; }
        .act-btn { flex: 1; padding: 14px; border-radius: 12px; font-size: 13px; font-weight: 700; text-align: center; cursor: pointer; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; gap: 6px; text-decoration: none; color: var(--primary); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);}
        
        /* ‚òÖ SAVE ANIMATION ‚òÖ */
        .act-save { transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .act-save.saved { 
            background-color: var(--pink); 
            color: white; 
            border-color: var(--pink); 
            animation: pop 0.4s ease-out;
        }
        .act-vibe { background: var(--primary); color: white; border-color: var(--primary); }

        @keyframes pop {
            0% { transform: scale(1); }
            40% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        .hidden { display: none !important; }
        
        /* ‚òÖ PIN STYLES ‚òÖ */
        img.leaflet-marker-icon { transition: all 0.3s; }
        .pin-sys { filter: hue-rotate(140deg) brightness(0.9); } /* Greenish */
        
        /* Pink Pin: Blue(240) + 90 = 330(Pink) */
        .pin-sav { 
            filter: hue-rotate(90deg) saturate(3) brightness(1.2); 
            transform: scale(1.5) translateY(-15px); 
            z-index: 1000 !important; 
        } 
    </style>
</head>
<body>

<div class="container">
    <div class="lang-switch" onclick="toggleLang()" id="lang-btn">EN / JP</div>

    <div id="start-screen" class="header">
        <span class="brand-tag">Travel ID</span>
        <h1 id="t-head">Decode Your<br>Travel DNA.</h1>
        <p class="hero-sub" id="t-sub">We don't match you by demographics.<br>We match you by values.</p>
        <button class="btn-primary" onclick="startQuiz()">
            <span id="t-start">Analyze My Style</span> <span>‚Üí</span>
        </button>
        <div style="margin-top:40px; border-top:1px solid #f1f5f9; padding-top:20px;">
            <p style="font-size:11px; color:#9ca3af; line-height:1.5;">v28.0 (Impact & Vibe)</p>
        </div>
    </div>

    <div id="quiz-screen" class="hidden">
        <div class="progress-track"><div class="progress-bar" id="progress"></div></div>
        <span class="q-cat" id="q-cat">CATEGORY</span>
        <div class="q-text" id="q-text">Loading...</div>
        <div id="options-box"></div>
        <div style="margin-top:20px; text-align:center;">
            <span onclick="prevQ()" style="font-size:12px; color:#9ca3af; cursor:pointer; text-decoration:underline;">Back</span>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <div class="res-header">
            <span class="brand-tag">YOUR SEGMENT</span>
            
            <div class="id-kanji" id="res-kanji">„Äê „Äë</div>
            <h1 class="id-title" id="res-id">Loading...</h1>

            <div class="type-img-container" id="img-container">
                <img id="type-image" class="type-img" src="" alt="Type Illustration" onerror="this.parentElement.style.display='none'">
            </div>

            <p class="id-desc" id="res-desc">Analysis complete.</p>
            
            <div class="tribe-actions">
                <button class="tribe-btn discord" onclick="copyDiscordProfile()">
                    <span>üìã</span> <span id="btn-discord">Copy Profile for Discord</span>
                </button>
                <a href="https://forms.gle/5L7ndRzgPnh45Mor8" target="_blank" class="tribe-btn">
                    <span>‚ö°</span> <span id="btn-submit">Submit Spot</span>
                </a>
                <div class="tribe-btn" onclick="shareTwitter()">
                    <span>ùïè</span> Share
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="ctrl-pill active" onclick="setMode('japan')" id="opt-japan">Japan</div>
            <div class="ctrl-pill" onclick="setMode('world')" id="opt-world">Global</div>
            <div class="ctrl-share">
                <div class="ctrl-pill" onclick="shareUrl()">üîó Copy URL</div>
            </div>
        </div>

        <div id="map-container"><div id="map"></div></div>

        <div class="spot-card">
            <h3 class="spot-n" id="spot-name">Map Loading...</h3>
            <p class="spot-d" id="spot-desc">Select a pin to reveal spots.</p>
            <div class="actions">
                <button class="act-btn act-save" id="btn-save" onclick="toggleSave()">
                    <span id="icon-save">‚ô°</span> <span id="txt-save">Save</span>
                </button>
                <a href="#" target="_blank" class="act-btn act-vibe" id="btn-insta">
                    <span>‚ñ∂</span> <span id="txt-insta">Vibe</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    // --- 1. CONFIGURATION ---
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRrOI46FP-ueet2ZD0xKG0r1_xFng90_PDr1Z-sm6OB5xe3I8m0nx5Q5aNIVxvRVi1QLczBbv4pdnAv/pub?output=csv'; 
    
    // --- 2. STATE ---
    let lang = 'en'; 
    let mode = 'japan'; 
    let finalId = ""; // e.g. "Ê≥•ÊîªÂ≠§ÈÅä"
    let map = null;
    let markers = [];
    let dataCache = {};
    let saved = new Set();
    let curSpot = null;

    // --- 3. LOGIC ---
    function init(){
        const urlParams = new URLSearchParams(window.location.search);
        const sharedId = urlParams.get('id');
        const localSaved = JSON.parse(localStorage.getItem('tid_saved') || '[]');
        saved = new Set(localSaved);

        fetchData(() => {
            if(sharedId) {
                finalId = sharedId;
                showResultScreen();
            } else {
                updateUIText();
            }
        });
    }

    function fetchData(callback){
        Papa.parse(CSV_URL, {
            download: true, header: true, skipEmptyLines: true,
            complete: res => {
                res.data.forEach(r => {
                    if(r.id){
                        const k = r.id.trim();
                        if(!dataCache[k]) dataCache[k] = [];
                        dataCache[k].push({
                            uid: r.uid || Math.random().toString(), 
                            name_jp: r.rec_jp, name_en: r.rec_en,
                            desc: r.desc, tag: r.tag ? r.tag.trim() : "",
                            lat: parseFloat(r.lat), lng: parseFloat(r.lng), 
                            zoom: parseInt(r.zoom)||12, region: r.region ? r.region.trim().toLowerCase() : 'japan'
                        });
                    }
                });
                if(callback) callback();
            }
        });
    }

    // --- BRAND DATA ---
    const T = {
        en: {
            head: "Decode Your\nTravel DNA.", sub: "We don't match you by demographics.\nWe match you by values.",
            start: "Analyze My Style", save: "Save", saved: "Saved!", vibe: "View Vibe",
            world: "Global", japan: "Domestic", 
            discord: "Copy Profile for Discord", submit: "Submit Spot",
            types: {
                "Ê≥•ÊîªÂ≠§ÈÅä": { t: "The Unfiltered Explorer", d: "Raw √ó Intense √ó Solo √ó Spontaneous.\nA nomad who seeks truth over comfort. You find beauty in the chaos that others reject." },
                "ÊµÑÂÆâÂÖ±Âæã": { t: "The Aesthetic Planner", d: "Refined √ó Gentle √ó Social √ó Structured.\nA guardian of beauty. You curate perfect harmony and reject the noise of the world." },
                "Ê≥•ÂÆâÂÖ±ÈÅä": { t: "The Immersion Seeker", d: "Raw √ó Gentle √ó Social √ó Spontaneous.\nA connector of souls. You dive into local life with an open heart and zero judgement." },
                "ÊµÑÊîªÂ≠§Âæã": { t: "The Noble Sniper", d: "Refined √ó Intense √ó Solo √ó Structured.\nA stoic perfectionist. You don't tour; you hunt for the sublime moment in solitude." },
                "fallback": { t: "The Unique Voyager", d: "Your value map is unique. Based on your traits, we've matched you with the closest tribe." }
            }
        },
        ja: {
            head: "ÊóÖ„ÅÆDNA„Çí\nËß£Ë™≠„Åô„Çã„ÄÇ", sub: "Â±ûÊÄß„Åß„ÅØ„Å™„Åè„ÄÅ\n„Äå‰æ°ÂÄ§Ë¶≥„Äç„Åß‰∏ñÁïå„ÇíÂÜçÂÆöÁæ©„Åô„Çã„ÄÇ",
            start: "„Çπ„Çø„Ç§„É´„ÇíÂàÜÊûê", save: "‰øùÂ≠ò", saved: "‰øùÂ≠òÂÆå‰∫Ü", vibe: "ÂãïÁîª„ÇíË¶ã„Çã",
            world: "‰∏ñÁïå", japan: "Êó•Êú¨",
            discord: "DiscordÁî®„Éó„É≠„Éï„Çí„Ç≥„Éî„Éº", submit: "ËÅñÂú∞„Çí„Çø„É¨„Åì„ÇÄ",
            types: {
                "Ê≥•ÊîªÂ≠§ÈÅä": { t: "The Unfiltered Explorer", d: "„ÄêRaw √ó Intense √ó Solo √ó Spontaneous„Äë\nÈ£æ„Çâ„Å™„ÅÑÊé¢Á©∂ËÄÖ„ÄÇÂÆâÂÖ®„Å™È£ºËÇ≤Â∞èÂ±ã„Çà„Çä„ÄÅÂÇ∑„Å†„Çâ„Åë„ÅÆËçíÈáé„ÇíÈÅ∏„Å∂„ÄÇ„Ç´„Ç™„Çπ„ÅÆ‰∏≠„Å´„Åì„Åù„ÄåÁîü„Äç„Åå„ÅÇ„Çã„ÄÇ" },
                "ÊµÑÂÆâÂÖ±Âæã": { t: "The Aesthetic Planner", d: "„ÄêRefined √ó Gentle √ó Social √ó Structured„Äë\nÁæéÂ≠¶„ÅÇ„ÇãË®àÁîªËÄÖ„ÄÇ„Éé„Ç§„Ç∫„ÇíÂæπÂ∫ï„Åó„Å¶ÊéíÈô§„Åó„ÄÅÂú∞‰∏ä„Å´ÂÆåÁíß„Å™Ê•ΩÂúíÔºà„Çµ„É≥„ÇØ„ÉÅ„É•„Ç¢„É™Ôºâ„ÇíË®≠Ë®à„Åô„Çã„ÄÇ" },
                "Ê≥•ÂÆâÂÖ±ÈÅä": { t: "The Immersion Seeker", d: "„ÄêRaw √ó Gentle √ó Social √ó Spontaneous„Äë\nÊ≤°ÂÖ•„Åô„Çã‰∫∫„ÄÇÊ∏ÖÊøÅ‰Ωµ„ÅõÂëë„ÇÄÊúÄÂº∑„ÅÆÂÖçÁñ´Âäõ„Åß„ÄÅ„Å©„Çì„Å™Ë∑ØÂú∞Ë£è„Å´„ÇÇ„ÄåÊÑõ„Äç„ÇíË¶ã„Å§„ÅëÂá∫„Åô„ÄÇ" },
                "ÊµÑÊîªÂ≠§Âæã": { t: "The Noble Sniper", d: "„ÄêRefined √ó Intense √ó Solo √ó Structured„Äë\nÂ≠§È´ò„ÅÆÁãôÊíÉÊâã„ÄÇÂ¶•Âçî„Å™„ÅçÁæéÊÑèË≠ò„ÄÇ„ÅÇ„Å™„Åü„Åå„Åô„Çã„ÅÆ„ÅØË¶≥ÂÖâ„Åß„ÅØ„Å™„ÅÑ„ÄÅÁæé„ÇíÊíÉ„Å°Êäú„Åè„ÄåÁã©„Çä„Äç„Å†„ÄÇ" },
                "fallback": { t: "The Unique Voyager", d: "Áã¨Ëá™„ÅÆÊóÖ„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÅÇ„Å™„Åü„ÅÆ‰æ°ÂÄ§Ë¶≥„Å´ÊúÄ„ÇÇËøë„ÅÑÈÉ®ÊóèÔºà„Éà„É©„Ç§„ÉâÔºâ„ÅÆÂú∞Âõ≥„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ" }
            }
        }
    };

    const Q = [
        { cat: "ENVIRONMENT", ja: "Áµ∂ÊôØ„ÅÆ‰ª£ÂÑü„Åå‰∏çË°õÁîü„Å™Â∞èÂ±ã„Å†„Å®„Åó„Å¶„ÇÇ„ÄÅ„Åù„Åì„Å´Ê≥ä„Åæ„Çã„ÅãÔºü", en: "Would you sleep in a dirty hut for a priceless view?", pos:{mud:2}, neg:{clean:2} },
        { cat: "CONSUMPTION", ja: "Âæó‰Ωì„ÅÆÁü•„Çå„Å™„ÅÑÁèæÂú∞„ÅÆÂ±ãÂè∞ÊñôÁêÜ„ÄÇ„É™„Çπ„ÇØ„ÇíË≤†„Å£„Å¶„Åß„ÇÇÈ£ü„Åπ„Çã„ÅãÔºü", en: "Do you eat mysterious local street food despite risks?", pos:{mud:2}, neg:{clean:2} },
        { cat: "ISOLATION", ja: "ÊñáÊòé„Åã„ÇâÂàáÊñ≠„Åï„Çå„Åü‰∏ç‰æø„Å™Â†¥ÊâÄ„ÄÇ„Åù„Çå„ÅØËã¶Áóõ„Åã„ÄÅËß£Êîæ„ÅãÔºü", en: "Is total isolation from civilization 'pain' or 'freedom'?", pos:{mud:1,solo:1}, neg:{clean:1,social:1} },
        { cat: "UNCERTAINTY", ja: "Âú∞Âõ≥„ÇíÊåÅ„Åü„Åö„Å´Ëø∑Â≠ê„Å´„Å™„Çã„Åì„Å®„ÄÇ„Åù„Çå„ÅØ„Çπ„Éà„É¨„Çπ„Åã„ÄÅÂñú„Å≥„ÅãÔºü", en: "Is getting lost without a map 'stress' or 'joy'?", pos:{flow:2}, neg:{order:2} },
        { cat: "CONTROL", ja: "ÂàÜÂçò‰Ωç„ÅßÂÆåÁíß„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„ÄÇÂÆâÂøÉ„Åô„Çã„Åã„ÄÅÊÅØËã¶„Åó„ÅÑ„ÅãÔºü", en: "Does a perfect schedule make you feel 'safe' or 'trapped'?", pos:{order:2}, neg:{flow:2} },
        { cat: "ADAPTABILITY", ja: "ÊóÖ„ÅÆ„Éà„É©„Éñ„É´„ÅØ„Äå„Ç®„É©„Éº„Äç„Åã„ÄÅ„Åù„Çå„Å®„ÇÇ„Äå„Éâ„É©„Éû„Äç„ÅãÔºü", en: "Are travel troubles 'errors' or 'drama'?", pos:{flow:2}, neg:{order:2} },
        { cat: "INTENSITY", ja: "ÊóÖ„ÅÆÁõÆÁöÑ„ÅØ„ÄåÁôí„ÇÑ„Åó„Äç„Åã„ÄÅ„Åù„Çå„Å®„ÇÇ„ÄåÊ∂àËÄó„Äç„ÅãÔºü", en: "Is the goal of travel 'healing' or 'exhaustion'?", pos:{safe:2}, neg:{active:2} },
        { cat: "RISK", ja: "Ê≤ªÂÆâ„ÅÆÊÇ™„ÅÑ„Çπ„É©„É†Ë°ó„ÄÇÂÆâÂÖ®Âúè„Åã„ÇâË¶ã„Çã„Åã„ÄÅÈôç„Çä„Å¶Ê≠©„Åè„ÅãÔºü", en: "Would you walk inside a gritty slum or watch from a bus?", pos:{active:2}, neg:{safe:2} },
        { cat: "INVESTMENT", ja: "‰∫àÁÆó„Çí‰Ωø„ÅÜ„Å™„Çâ„ÄåÊ•µ‰∏ä„ÅÆÂÆâÊÅØ„Äç„Åã„ÄÅ„ÄåÊ•µÈôê„ÅÆ‰ΩìÈ®ì„Äç„ÅãÔºü", en: "Invest in 'luxury rest' or 'extreme experience'?", pos:{safe:2}, neg:{active:2} },
        { cat: "SOLITUDE", ja: "Â§ßËá™ÁÑ∂„ÅÆ‰∏≠„Åß„ÅÆÂ≠§Áã¨„ÄÇÂØÇ„Åó„ÅÑ„Åã„ÄÅÂÖ®ËÉΩÊÑü„ÇíÊÑü„Åò„Çã„ÅãÔºü", en: "Alone in nature: Do you feel 'lonely' or 'empowered'?", pos:{solo:2}, neg:{social:2} },
        { cat: "CONNECTION", ja: "Ë®ÄËëâ„ÅÆÈÄö„Åò„Å™„ÅÑÁèæÂú∞‰∫∫„Å®„ÅÆ‰∫§ÊµÅ„ÄÇÈÅø„Åë„Çã„Åã„ÄÅÈ£õ„Å≥Ëæº„ÇÄ„ÅãÔºü", en: "Interacting with locals: Avoid or Dive in?", pos:{social:2}, neg:{solo:2} },
        { cat: "PARTNER", ja: "ÂêåË°åËÄÖ„ÅØ„ÄåÂæìÈ†Ü„Å™‰∫∫„Äç„Åã„ÄÅ„ÄåÊåØ„ÇäÂõû„Åó„Å¶„Åè„Çã‰∫∫„Äç„ÅãÔºü", en: "Partner preference: 'Obedient' or 'Crazy'?", pos:{social:1,flow:1}, neg:{solo:1,order:1} },
        { cat: "CORE", ja: "ÊóÖ„Å®„ÅØ„ÄåÊó•Â∏∏„ÅÆÂõûÂæ©„Äç„Åã„ÄÅ„Åù„Çå„Å®„ÇÇ„Äå‰æ°ÂÄ§Ë¶≥„ÅÆÁ†¥Â£ä„Äç„ÅãÔºü", en: "Travel is: 'Restoring daily life' or 'Destroying values'?", pos:{active:2,mud:1}, neg:{safe:2,clean:1} }
    ];

    let qIdx = 0;
    let scores = {mud:0, clean:0, flow:0, order:0, active:0, safe:0, solo:0, social:0};

    function toggleLang(){
        lang = lang==='en' ? 'ja' : 'en';
        updateUIText();
        if(finalId) updateResultUI(); 
        else if(qIdx>0) renderQ(); 
    }

    function updateUIText(){
        const t = T[lang];
        document.getElementById('t-head').innerHTML = t.head.replace('\n', '<br>');
        document.getElementById('t-sub').innerHTML = t.sub.replace('\n', '<br>');
        document.getElementById('t-start').innerText = t.start;
        document.getElementById('lang-btn').innerText = lang==='en' ? "EN / JP" : "JP / EN";
    }

    function startQuiz(){
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        renderQ();
    }

    function renderQ(){
        if(qIdx >= Q.length){ finishQuiz(); return; }
        const q = Q[qIdx];
        document.getElementById('q-cat').innerText = q.cat;
        document.getElementById('q-text').innerText = lang==='ja' ? q.ja : q.en;
        document.getElementById('progress').style.width = `${((qIdx)/Q.length)*100}%`;
        
        const box = document.getElementById('options-box');
        box.innerHTML = '';
        const opts = [
            { l: lang==='ja'?"Âº∑„Åè„Åù„ÅÜÊÄù„ÅÜ":"Strongly Agree", w: 2, c: "opt-5" },
            { l: lang==='ja'?"„Åù„ÅÜÊÄù„ÅÜ":"Agree", w: 1, c: "opt-4" },
            { l: lang==='ja'?"„Å©„Å°„Çâ„Åß„ÇÇ„Å™„ÅÑ":"Neutral", w: 0, c: "opt-3" },
            { l: lang==='ja'?"„Åù„ÅÜÊÄù„Çè„Å™„ÅÑ":"Disagree", w: -1, c: "opt-2" },
            { l: lang==='ja'?"ÂÖ®„Åè„Åù„ÅÜÊÄù„Çè„Å™„ÅÑ":"Strongly Disagree", w: -2, c: "opt-1" }
        ];
        opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = `opt-btn ${o.c}`;
            btn.innerHTML = `<span>${o.l}</span>`; 
            btn.onclick = () => {
                if(o.w > 0) Object.keys(q.pos).forEach(k => scores[k] += q.pos[k] * o.w);
                if(o.w < 0) Object.keys(q.neg).forEach(k => scores[k] += q.neg[k] * Math.abs(o.w));
                qIdx++; renderQ();
            };
            box.appendChild(btn);
        });
    }

    function prevQ(){ if(qIdx > 0){ qIdx--; renderQ(); } else { location.reload(); } }

    function finishQuiz(){
        const axis1 = scores.mud >= scores.clean ? "Ê≥•" : "ÊµÑ";
        const axis2 = scores.active >= scores.safe ? "Êîª" : "ÂÆâ";
        const axis3 = scores.social >= scores.solo ? "ÂÖ±" : "Â≠§";
        const axis4 = scores.flow >= scores.order ? "ÈÅä" : "Âæã";
        finalId = axis1 + axis2 + axis3 + axis4;
        showResultScreen();
    }

    function showResultScreen(){
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        updateResultUI();
        setTimeout(() => { initMap(); if(map) map.invalidateSize(); }, 200);
    }

    function updateResultUI(){
        document.getElementById('res-kanji').innerText = `„Äê ${finalId} „Äë`;

        // Image Logic: Try to load ./images/Ê≥•ÊîªÂ≠§ÈÅä.png
        const img = document.getElementById('type-image');
        const imgCon = document.getElementById('img-container');
        img.src = `./images/${finalId}.png`;
        img.onload = () => { imgCon.style.display = 'block'; };
        // onerror is handled inline

        let tData = T[lang].types[finalId];
        if(!tData){
            if(finalId.includes("Ê≥•") && finalId.includes("Êîª")) tData = T[lang].types["Ê≥•ÊîªÂ≠§ÈÅä"];
            else if(finalId.includes("ÊµÑ") && finalId.includes("ÂÆâ")) tData = T[lang].types["ÊµÑÂÆâÂÖ±Âæã"];
            else if(finalId.includes("Ê≥•") && finalId.includes("ÂÖ±")) tData = T[lang].types["Ê≥•ÂÆâÂÖ±ÈÅä"];
            else if(finalId.includes("ÊµÑ") && finalId.includes("Êîª")) tData = T[lang].types["ÊµÑÊîªÂ≠§Âæã"];
            else tData = T[lang].types["fallback"];
        }

        document.getElementById('res-id').innerText = tData.t;
        document.getElementById('res-desc').innerText = tData.d;
        
        const t = T[lang];
        document.getElementById('btn-discord').innerText = t.discord;
        document.getElementById('btn-submit').innerText = t.submit;
        document.getElementById('opt-world').innerText = t.world;
        document.getElementById('opt-japan').innerText = t.japan;
        document.getElementById('txt-save').innerText = t.save;
        document.getElementById('txt-insta').innerText = t.vibe;

        if(map) updateMap();
    }

    function setMode(m){
        mode = m;
        document.getElementById('opt-world').classList.toggle('active', m==='world');
        document.getElementById('opt-japan').classList.toggle('active', m==='japan');
        updateMap();
    }

    function initMap(){
        if(map) { map.invalidateSize(); return; }
        map = L.map('map');
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 19
        }).addTo(map);
        updateMap();
    }

    function updateMap(){
        if(!map) return;
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        let rawSpots = dataCache[finalId];
        if(!rawSpots || rawSpots.length === 0){
             const keys = Object.keys(dataCache);
             for(let k of keys){
                 if(finalId.includes(k.substring(0,2))) { rawSpots = dataCache[k]; break; }
             }
             if(!rawSpots) rawSpots = Object.values(dataCache).flat();
        }

        let spots = [];
        if(mode === 'japan') spots = rawSpots.filter(s => s.region === 'japan');
        else spots = rawSpots.filter(s => s.region === 'world');

        if(!spots || spots.length === 0) { map.setView([36.0, 138.0], 5); return; }

        const bounds = [];
        spots.forEach(s => {
            const isSaved = saved.has(s.uid);
            const cls = isSaved ? 'pin-sav' : 'pin-sys';
            const icon = L.divIcon({className:'', html:`<img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="leaflet-marker-icon ${cls}" style="margin-left:-12px; margin-top:-41px;">`});
            
            const m = L.marker([s.lat, s.lng], {icon:icon}).addTo(map);
            m.on('click', () => showSpot(s));
            markers.push(m);
            bounds.push([s.lat, s.lng]);
        });

        if(spots.length===1) map.setView([spots[0].lat, spots[0].lng], spots[0].zoom);
        else map.fitBounds(bounds, {padding:[50,50]});

        showSpot(spots[0]);
    }

    function showSpot(s){
        curSpot = s;
        const n = lang==='ja' ? (s.name_jp||s.rec) : (s.name_en||s.rec);
        document.getElementById('spot-name').innerText = n;
        document.getElementById('spot-desc').innerText = s.desc || "Recommended Spot";
        
        const btnInsta = document.getElementById('btn-insta');
        if(s.tag){
            btnInsta.href = `https://www.instagram.com/explore/tags/${s.tag}/`;
            btnInsta.style.opacity = 1; btnInsta.style.pointerEvents = 'auto';
        } else {
            btnInsta.style.opacity = 0.5; btnInsta.style.pointerEvents = 'none';
        }
        updateSaveBtn();
    }

    function toggleSave(){
        if(!curSpot) return;
        const k = curSpot.uid;
        if(saved.has(k)) saved.delete(k); else saved.add(k);
        localStorage.setItem('tid_saved', JSON.stringify([...saved]));
        updateSaveBtn();
        updateMap();
    }

    function updateSaveBtn(){
        if(!curSpot) return;
        const isSaved = saved.has(curSpot.uid);
        const btn = document.getElementById('btn-save');
        const icon = document.getElementById('icon-save');
        const txt = document.getElementById('txt-save');
        const t = T[lang];

        if(isSaved){
            btn.classList.add('saved');
            icon.innerText = '‚ô•';
            txt.innerText = t.saved;
        } else {
            btn.classList.remove('saved');
            icon.innerText = '‚ô°';
            txt.innerText = t.save;
        }
    }

    function copyDiscordProfile() {
        const tData = T[lang].types[finalId] || T[lang].types["fallback"];
        let recSpot = "Not selected";
        
        // Find best recommended spot
        if(dataCache[finalId] && dataCache[finalId].length > 0) {
            recSpot = lang==='ja' ? dataCache[finalId][0].name_jp : dataCache[finalId][0].name_en; 
        }

        const text = `**„Äê${finalId}„Äë (${tData.t})**\n${tData.d}\n\nüìç Recommended: ${recSpot}\n#TravelID\n${window.location.href}`;
        
        navigator.clipboard.writeText(text).then(() => {
            alert(lang==='ja' ? "„Éó„É≠„Éï„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅDiscord„Å´Ë≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ" : "Profile copied! Paste it in Discord.");
        });
    }

    function shareUrl() {
        const savedArr = Array.from(saved);
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?id=${finalId}&saved=${savedArr.join(',')}`;
        navigator.clipboard.writeText(shareUrl).then(() => {
            alert(lang==='ja' ? "URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ" : "URL Copied!");
        });
    }

    function shareTwitter() {
        const tData = T[lang].types[finalId] || T[lang].types["fallback"];
        const text = `I am "${tData.t}". My Travel ID is „Äê${finalId}„Äë. #TravelID`;
        const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`;
        window.open(url, '_blank');
    }

    init();
</script>
</body>
</html>