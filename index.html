<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel ID - Ultimate Atlas</title>
    <link rel="icon" href="./images/logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9SCPDPG40L"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9SCPDPG40L');</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root{--primary:#3b82f6;--accent:#8b5cf6;--bg:#f8fafc;--card:#ffffff;--text:#1e293b;--x-color:#000000;--discord-color:#5865F2;--danger:#ef4444;--match:#db2777;--insta-grad:linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);}
        body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",YuGothic,sans-serif;background-color:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.6;}
        .container{background:var(--card);width:100%;max-width:500px;margin:0 auto;padding:30px;border-radius:24px;box-shadow:0 10px 30px rgba(0,0,0,0.08);text-align:center;position:relative;overflow:hidden;}
        
        /* Switch UI */
        .mode-switch-container { display: flex; justify-content: center; margin: 20px 0; }
        .mode-switch { display: flex; background: #e2e8f0; border-radius: 30px; padding: 4px; position: relative; cursor: pointer; width: 200px; height: 40px; align-items: center; }
        .mode-option { flex: 1; text-align: center; font-weight: bold; font-size: 14px; z-index: 2; color: #64748b; transition: color 0.3s; }
        .mode-option.active { color: white; }
        .mode-bg { position: absolute; top: 2px; left: 2px; width: 50%; height: 36px; background: var(--primary); border-radius: 28px; transition: left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 1; }
        .mode-switch.japan-mode .mode-bg { left: 50%; background: #ef4444; }

        /* Map Style */
        #map-container { width: 100%; height: 350px; border-radius: 16px; margin-top: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; border: 2px solid #e2e8f0;}
        #map { width: 100%; height: 100%; }
        
        /* UI Elements */
        .lang-switch{position:absolute;top:20px;right:20px;background:#f1f5f9;padding:5px 10px;border-radius:20px;font-size:12px;font-weight:bold;cursor:pointer;border:1px solid #e2e8f0;color:#64748b;}
        h1{font-size:24px;margin:10px 0;font-weight:800;}
        button.start-btn{background:linear-gradient(135deg,var(--primary),var(--accent));color:white;border:none;font-size:20px;padding:20px 40px;width:100%;margin-top:20px;border-radius:16px;font-weight:bold;cursor:pointer;}
        .hidden{display:none;}
        .options-list{text-align:left;display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
        .option-label{padding:15px;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;}
        .option-label.selected{border-color:var(--primary);background:#eff6ff;}
        
        .info-box{background:#f1f5f9;border-radius:16px;padding:20px;text-align:left;margin-bottom:15px;border:1px solid #e2e8f0;}
        .info-title{font-size:12px;font-weight:bold;color:#64748b;margin-bottom:5px;text-transform:uppercase;}
        .info-content{font-size:16px;font-weight:bold;color:#334155;}
        .insta-btn { display: block; width: 100%; margin-top: 15px; padding: 12px; background: var(--insta-grad); color: white; border: none; border-radius: 12px; font-weight: bold; text-decoration: none; text-align: center; box-sizing: border-box; transition: 0.2s;}
        .insta-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .share-area { display: flex; gap: 10px; margin: 20px 0; }
        button.share-btn { flex: 1; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s;}
        button.share-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .x { background: var(--x-color); } .discord { background: var(--discord-color); }
        
        /* Map Popup Customization */
        .map-card { width: 160px; }
        .map-card h4 { margin: 0 0 5px 0; font-size: 14px; color: #1e293b; }
        .map-card p { font-size: 11px; margin: 0; color: #64748b; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-switch" onclick="toggleLanguage()" id="lang-btn">ğŸ‡¯ğŸ‡µ JP / ğŸ‡ºğŸ‡¸ EN</div>

    <div id="start-screen">
        <h1 id="start-title">Travel ID è¨ºæ–­</h1>
        <p id="start-subtitle">ä¸–ç•Œã¨æ—¥æœ¬ã€ã‚ãªãŸã®ã€Œå±…å ´æ‰€ã€ã‚’è¦‹ã¤ã‘ã¾ã™ã€‚</p>
        <img src="./images/logo.png" style="width:180px; margin:20px auto; display:block;">
        <button class="start-btn" onclick="startQuiz()" id="start-btn-text">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
        <p style="font-size:10px; color:#cbd5e1; margin-top:15px;">Powered by Google Sheets</p>
    </div>

    <div id="quiz-screen" class="hidden">
        <h2 id="q-text">Loading...</h2>
        <div class="options-list" id="options-container"></div>
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="color:#3b82f6;margin-bottom:5px;" id="result-label">ã‚ãªãŸã®ID</h2>
        <h1 id="result-id" style="font-size:32px;margin:0 0 10px 0;background:linear-gradient(45deg,#3b82f6,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;"></h1>
        <p id="result-desc" style="font-size:14px;color:#64748b;"></p>

        <div class="mode-switch-container">
            <div class="mode-switch" onclick="toggleMapMode()" id="mode-switch">
                <div class="mode-bg"></div>
                <div class="mode-option active" id="opt-world">ğŸŒ World</div>
                <div class="mode-option" id="opt-japan">ğŸ‡¯ğŸ‡µ Japan</div>
            </div>
        </div>

        <div class="info-box">
            <div class="info-title" id="rec-label">ğŸ—ºï¸ ãŠã™ã™ã‚ã®æ—…å…ˆ</div>
            <div class="info-content" id="rec-content">Loading data...</div>
            <a href="#" target="_blank" class="insta-btn" id="insta-link">ğŸ“· ã“ã®å ´æ‰€ã‚’å‹•ç”»ã§è¦‹ã‚‹</a>
        </div>

        <div id="map-container"><div id="map"></div></div>

        <div class="share-area">
            <button class="share-btn x" onclick="shareOnX()">X (Twitter)</button>
            <button class="share-btn discord" onclick="copyForDiscord()">Discord</button>
        </div>
        
        <button onclick="location.reload()" style="margin-top:20px;background:#f1f5f9;border:none;padding:12px 20px;border-radius:20px;width:100%;color:#64748b;font-weight:bold;cursor:pointer;">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // â˜… è¨­å®šå®Œäº†ï¼ã‚ãªãŸã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã§ã™ â˜…
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRrOI46FP-ueet2ZD0xKG0r1_xFng90_PDr1Z-sm6OB5xe3I8m0nx5Q5aNIVxvRVi1QLczBbv4pdnAv/pub?output=csv'; 

    let currentLang = 'ja';
    let currentMode = 'world'; 
    let finalId = "";
    let map = null;
    let markers = [];
    let japanDataCache = {}; // æ—¥æœ¬ãƒ‡ãƒ¼ã‚¿ç½®ãå ´

    // --- Translations ---
    const t = {
        ja: {
            title: "Travel ID è¨ºæ–­", sub: "ä¸–ç•Œã¨æ—¥æœ¬ã€ã‚ãªãŸã®å±…å ´æ‰€ã‚’è¦‹ã¤ã‘ã‚‹ã€‚",
            start: "è¨ºæ–­ã‚’å§‹ã‚ã‚‹", rec: "ãŠã™ã™ã‚ã®æ—…å…ˆ", insta: "ğŸ“· ã“ã®å ´æ‰€ã‚’å‹•ç”»ã§è¦‹ã‚‹",
            world: "ğŸŒ ä¸–ç•Œ", japan: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬",
            q: ["è¡›ç”ŸçŠ¶æ…‹ãŒæ‚ªãã¦ã‚‚çµ¶æ™¯ãªã‚‰æˆ‘æ…¢ã§ãã‚‹ï¼Ÿ", "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ±ºã‚ãšã€ãã®å ´ã®æ°—åˆ†ã§å‹•ããŸã„ï¼Ÿ", "å®‰å…¨ãªãƒªã‚¾ãƒ¼ãƒˆã‚ˆã‚Šã€å°‘ã—å±é™ºãªè·¯åœ°è£ã«ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ï¼Ÿ"],
            opts: ["å®Œå…¨ã«ãã†æ€ã†", "å…¨ããã†æ€ã‚ãªã„"]
        },
        en: {
            title: "Travel ID Diagnosis", sub: "Discover your true travel style.",
            start: "Start Quiz", rec: "Recommended Spot", insta: "ğŸ“· See Vibe on Instagram",
            world: "ğŸŒ World", japan: "ğŸ‡¯ğŸ‡µ Japan",
            q: ["Can you endure poor hygiene for a great view?", "Do you prefer spontaneity over planning?", "Do gritty alleys excite you more than safe resorts?"],
            opts: ["Strongly Agree", "Strongly Disagree"]
        }
    };

    // Base Data (Titles & World Mock Data)
    // â€»ä¸–ç•Œãƒ‡ãƒ¼ã‚¿ã‚‚å°†æ¥çš„ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒ–æ¨å¥¨
    const resultData = {
        "æ³¥æ”»å­¤éŠ": { ja: { title: "å­¤é«˜ã®ãƒãƒ¼ãƒ‰ã‚³ã‚¢å†’é™ºå®¶", desc: "å¿«é©ã•ã‚ˆã‚Šç”Ÿã®å®Ÿæ„Ÿã€‚ç›´æ„Ÿã§å‹•ãã€‚" }, en: { title: "The Lone Hardcore Adventurer", desc: "Raw reality over comfort." }, world: [{ rec: "ã‚¨ãƒã‚ªãƒ”ã‚¢ï¼ˆãƒ€ãƒŠã‚­ãƒ«ç ‚æ¼ ï¼‰", rec_en: "Ethiopia", tag: "AdventureTravel", lat: 14.0323, lng: 40.2936 }] },
        "æµ„å®‰å…±å¾‹": { ja: { title: "ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ»ã‚³ãƒ¼ãƒ‡ã‚£ãƒãƒ¼ã‚¿ãƒ¼", desc: "æ¸…æ½”ã¨ç§©åºã‚’æ„›ã™ã‚‹å®Œç’§ä¸»ç¾©è€…ã€‚" }, en: { title: "The Crystal Coordinator", desc: "Loves cleanliness and order." }, world: [{ rec: "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ï¼ˆãƒãƒªãƒ¼ãƒŠãƒ™ã‚¤ï¼‰", rec_en: "Singapore", tag: "LuxuryTravel", lat: 1.2834, lng: 103.8607 }] },
        // ä»®ãƒ‡ãƒ¼ã‚¿è£œå®Œï¼ˆä»–ã®ã‚¿ã‚¤ãƒ—ãŒå‡ºãŸæ™‚ç”¨ï¼‰
        "æµ„å®‰å…±éŠ": { ja: { title: "ã‚¢ãƒ¼ãƒãƒ³ãƒ»ã‚½ãƒ¼ã‚·ãƒ£ãƒ©ã‚¤ã‚¶ãƒ¼", desc: "éƒ½å¸‚ã®æ´—ç·´ã¨äº¤æµã‚’æ„›ã™ã‚‹ã€‚" }, en: { title: "Urban Socializer", desc: "Loves urban vibes." }, world: [{ rec: "ãƒ‹ãƒ¥ãƒ¼ãƒ¨ãƒ¼ã‚¯ï¼ˆãƒãƒ³ãƒãƒƒã‚¿ãƒ³ï¼‰", rec_en: "NYC", tag: "NYC", lat: 40.7128, lng: -74.0060 }] },
        "æµ„å®‰å­¤å¾‹": { ja: { title: "ãƒ”ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ»ãƒªãƒˆãƒªãƒ¼ã‚¿ãƒ¼", desc: "é™å¯‚ã¨ç§©åºã‚’æ„›ã™ã‚‹ã€‚" }, en: { title: "Peaceful Retreater", desc: "Loves silence." }, world: [{ rec: "ãƒ•ã‚£ãƒ³ãƒ©ãƒ³ãƒ‰ï¼ˆæ¹–ç•”ï¼‰", rec_en: "Finland", tag: "Finland", lat: 61.9241, lng: 25.7482 }] },
        "æµ„å®‰å­¤éŠ": { ja: { title: "ã‚»ãƒ¬ãƒ³ãƒ‡ã‚£ãƒ”ãƒ†ã‚£ãƒ»ãƒ›ãƒƒãƒ‘ãƒ¼", desc: "æ´—ç·´ã•ã‚ŒãŸæ”¾æµªã€‚" }, en: { title: "Serendipity Hopper", desc: "Loves stylish wandering." }, world: [{ rec: "ãƒ‘ãƒªï¼ˆãƒãƒ¬åœ°åŒºï¼‰", rec_en: "Paris", tag: "Paris", lat: 48.8566, lng: 2.3522 }] },
        "æµ„æ”»å…±å¾‹": { ja: { title: "ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼", desc: "å†’é™ºã¨è±ªè¯ã•ã®ä¸¡ç«‹ã€‚" }, en: { title: "Executive Explorer", desc: "Luxury adventure." }, world: [{ rec: "ãƒ‰ãƒã‚¤ï¼ˆç ‚æ¼ ãƒªã‚¾ãƒ¼ãƒˆï¼‰", rec_en: "Dubai", tag: "Dubai", lat: 25.2048, lng: 55.2708 }] },
        "æµ„æ”»å…±éŠ": { ja: { title: "ã‚«ãƒ«ãƒãƒ£ãƒ¼ãƒ»ã‚«ã‚¿ãƒªã‚¹ãƒˆ", desc: "æ–‡åŒ–ã«æ·±ãæ½œã‚‹ã€‚" }, en: { title: "Culture Catalyst", desc: "Deep cultural dive." }, world: [{ rec: "ãƒãƒ«ã‚»ãƒ­ãƒŠï¼ˆã‚¬ã‚¦ãƒ‡ã‚£ï¼‰", rec_en: "Barcelona", tag: "Barcelona", lat: 41.3851, lng: 2.1734 }] },
        "æµ„æ”»å­¤å¾‹": { ja: { title: "ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒ»ãƒˆãƒ¬ãƒƒã‚«ãƒ¼", desc: "å­¤ç‹¬ãªæŒ‘æˆ¦ã€‚" }, en: { title: "Mindful Trekker", desc: "Solo challenge." }, world: [{ rec: "ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰ï¼ˆæ°·æ²³ï¼‰", rec_en: "Iceland", tag: "Iceland", lat: 64.9631, lng: -19.0208 }] },
        "æµ„æ”»å­¤éŠ": { ja: { title: "ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ»ãƒãƒãƒ‰ãƒ»ã‚¨ãƒªãƒ¼ãƒˆ", desc: "ã©ã“ã§ã‚‚ç”Ÿãã‚‰ã‚Œã‚‹ã€‚" }, en: { title: "Digital Nomad", desc: "Live anywhere." }, world: [{ rec: "ãƒãƒªå³¶ï¼ˆãƒãƒ£ãƒ³ã‚°ãƒ¼ï¼‰", rec_en: "Bali", tag: "Bali", lat: -8.6500, lng: 115.1300 }] },
        "æ³¥å®‰å…±å¾‹": { ja: { title: "ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯ãƒ»ãƒ“ãƒ¬ã‚¸ãƒ£ãƒ¼", desc: "å¤ãè‰¯ãçµ†ã€‚" }, en: { title: "Nostalgic Villager", desc: "Old ties." }, world: [{ rec: "å°æ¹¾ï¼ˆä¹ä»½ï¼‰", rec_en: "Jiufen", tag: "Jiufen", lat: 25.1098, lng: 121.8452 }] },
        "æ³¥å®‰å…±éŠ": { ja: { title: "ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ãƒ»ã‚¸ãƒ£ãƒ³ã‚­ãƒ¼", desc: "ã‚«ã‚ªã‚¹ã¨ç†±ç‹‚ã€‚" }, en: { title: "Festival Junkie", desc: "Chaos and hype." }, world: [{ rec: "ã‚¿ã‚¤ï¼ˆã‚«ã‚ªã‚µãƒ³é€šã‚Šï¼‰", rec_en: "Khao San Road", tag: "KhaoSan", lat: 13.7589, lng: 100.4974 }] },
        "æ³¥å®‰å­¤å¾‹": { ja: { title: "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ»ã‚¹ãƒˆã‚¤ãƒƒã‚¯", desc: "é™ã‹ãªæ²¡å…¥ã€‚" }, en: { title: "Local Stoic", desc: "Quiet immersion." }, world: [{ rec: "ãƒ©ã‚ªã‚¹ï¼ˆãƒ«ã‚¢ãƒ³ãƒ‘ãƒãƒ¼ãƒ³ï¼‰", rec_en: "Luang Prabang", tag: "Laos", lat: 19.8833, lng: 102.1333 }] },
        "æ³¥å®‰å­¤éŠ": { ja: { title: "è·¯åœ°è£ãƒ•ãƒ©ãƒŒãƒ¼ãƒ«", desc: "å“€æ„ã®æ¢æ±‚ã€‚" }, en: { title: "Alleyway Flaneur", desc: "Seeking nostalgia." }, world: [{ rec: "ãƒ™ãƒˆãƒŠãƒ ï¼ˆãƒãƒã‚¤æ—§å¸‚è¡—ï¼‰", rec_en: "Hanoi", tag: "Hanoi", lat: 21.0285, lng: 105.8542 }] },
        "æ³¥æ”»å…±å¾‹": { ja: { title: "ã‚µãƒã‚¤ãƒãƒ«ãƒ»ãƒãƒ¼ãƒ ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼", desc: "å”åŠ›ã—ã¦ç”Ÿãæ®‹ã‚‹ã€‚" }, en: { title: "Survival Team", desc: "Survive together." }, world: [{ rec: "ã‚¢ãƒã‚¾ãƒ³å·ï¼ˆãƒ„ã‚¢ãƒ¼ï¼‰", rec_en: "Amazon", tag: "Amazon", lat: -3.4653, lng: -62.2159 }] },
        "æ³¥æ”»å…±éŠ": { ja: { title: "ã‚«ã‚ªã‚¹ãƒ»ãƒ€ã‚¤ãƒãƒ¼", desc: "æ··æ²Œã¸é£›ã³è¾¼ã‚€ã€‚" }, en: { title: "Chaos Diver", desc: "Dive into chaos." }, world: [{ rec: "ã‚¤ãƒ³ãƒ‰ï¼ˆãƒ‡ãƒªãƒ¼ï¼‰", rec_en: "Delhi", tag: "Delhi", lat: 28.6139, lng: 77.2090 }] },
        "æ³¥æ”»å­¤å¾‹": { ja: { title: "ãƒ­ãƒ¼ãƒ³ãƒ»ã‚¦ãƒ«ãƒ•ãƒ»ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼", desc: "è’é‡ã®å­¤ç‹¬ã€‚" }, en: { title: "Lone Wolf", desc: "Wilderness solo." }, world: [{ rec: "ãƒ‘ã‚¿ã‚´ãƒ‹ã‚¢", rec_en: "Patagonia", tag: "Patagonia", lat: -48.4239, lng: -72.5630 }] },
    };

    // --- Fetch Data from Google Sheet ---
    function fetchJapanData() {
        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    if(row.id) {
                        // é…åˆ—ã¨ã—ã¦ä¿å­˜ï¼ˆè¤‡æ•°ã‚¹ãƒãƒƒãƒˆå¯¾å¿œï¼‰
                        if (!japanDataCache[row.id]) japanDataCache[row.id] = [];
                        japanDataCache[row.id].push({
                            rec: row.rec_jp,
                            rec_en: row.rec_en,
                            desc: row.desc,
                            tag: row.tag,
                            lat: parseFloat(row.lat),
                            lng: parseFloat(row.lng),
                            zoom: parseInt(row.zoom)
                        });
                    }
                });
                console.log("Japan Data Loaded!", japanDataCache);
            }
        });
    }
    // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    fetchJapanData();

    // --- Core Logic ---
    function startQuiz() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        renderQuestion(0);
    }

    function renderQuestion(idx) {
        if(idx >= t.ja.q.length) return finishQuiz();
        document.getElementById('q-text').innerText = `Q${idx+1}. ${t[currentLang].q[idx]}`;
        const container = document.getElementById('options-container');
        container.innerHTML = `
            <div class="option-label" onclick="nextQ(${idx}, true)">${t[currentLang].opts[0]} (Mud)</div>
            <div class="option-label" onclick="nextQ(${idx}, false)">${t[currentLang].opts[1]} (Clean)</div>
        `;
    }
    
    let score = 0;
    function nextQ(idx, isMud) {
        if(isMud) score++;
        renderQuestion(idx + 1);
    }

    function finishQuiz() {
        // â˜…ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®Ÿéš›ã¯ä»¥å‰ã®16ã‚¿ã‚¤ãƒ—è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã«æˆ»ã—ã¦ãã ã•ã„ï¼‰
        // ã“ã“ã§ã¯ãƒ‡ãƒ¢ç”¨ã«ãƒ©ãƒ³ãƒ€ãƒ ã¾ãŸã¯ã‚¹ã‚³ã‚¢ã§æ±ºå®š
        // ä»Šå›ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã‚„ã™ãã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®ã‚ã‚‹ã‚¿ã‚¤ãƒ—ã«ãªã‚Šã‚„ã™ãã—ã¾ã™
        finalId = score > 1 ? "æ³¥æ”»å­¤éŠ" : "æµ„å®‰å…±å¾‹"; 
        
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        
        // åœ°å›³åˆæœŸåŒ–
        setTimeout(initMap, 100);
        updateResultUI();
    }

    function toggleMapMode() {
        currentMode = currentMode === 'world' ? 'japan' : 'world';
        const switchEl = document.getElementById('mode-switch');
        const optWorld = document.getElementById('opt-world');
        const optJapan = document.getElementById('opt-japan');
        
        if (currentMode === 'japan') {
            switchEl.classList.add('japan-mode');
            optWorld.classList.remove('active');
            optJapan.classList.add('active');
        } else {
            switchEl.classList.remove('japan-mode');
            optWorld.classList.add('active');
            optJapan.classList.remove('active');
        }
        updateResultUI();
    }

    function updateResultUI() {
        // IDãŒæœªå®šç¾©ã®å ´åˆã®ã‚¬ãƒ¼ãƒ‰
        if (!resultData[finalId]) finalId = "æµ„å®‰å…±å¾‹"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        const basicData = resultData[finalId];
        const basic = basicData[currentLang];
        document.getElementById('result-kanji').innerText = `ã€${finalId}ã€‘`;
        document.getElementById('result-id').innerText = basic.title;
        document.getElementById('result-desc').innerText = basic.desc;
        
        let spots = [];

        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        if (currentMode === 'japan') {
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
            if (japanDataCache[finalId] && japanDataCache[finalId].length > 0) {
                spots = japanDataCache[finalId];
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼ˆãƒ­ãƒ¼ãƒ‰ä¸­ãªã©ï¼‰
                document.getElementById('rec-content').innerText = "Loading data...";
                return;
            }
        } else {
            // ä¸–ç•Œãƒ¢ãƒ¼ãƒ‰
            spots = basicData.world || [];
        }
        
        // æœ€åˆã®ã‚¹ãƒãƒƒãƒˆã‚’ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã€å…¨ã‚¹ãƒãƒƒãƒˆã‚’åœ°å›³ã«è¡¨ç¤º
        if (spots.length > 0) {
            updateInfoBox(spots[0]);
            updateMapPins(spots);
        }
    }

    // æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ã®ä¸­èº«ã‚’æ›´æ–°
    function updateInfoBox(spot) {
        const name = currentLang === 'ja' ? spot.rec : spot.rec_en;
        document.getElementById('rec-content').innerText = name;
        document.getElementById('insta-link').href = `https://www.instagram.com/explore/tags/${spot.tag}/`;
        document.getElementById('insta-link').innerText = `${t[currentLang].insta} #${spot.tag}`;
    }

    function initMap() {
        const container = document.getElementById('map-container');
        container.style.display = 'block';
        if(map) { map.invalidateSize(); return; } // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ãªã‚‰ãƒªã‚µã‚¤ã‚ºã®ã¿
        
        map = L.map('map');
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
        }).addTo(map);
    }

    function updateMapPins(spots) {
        // æ—¢å­˜ãƒ”ãƒ³å‰Šé™¤
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        const bounds = [];

        // å…¨ã‚¹ãƒãƒƒãƒˆã«ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
        spots.forEach(spot => {
            const marker = L.marker([spot.lat, spot.lng]).addTo(map);
            
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã‚¤ãƒ™ãƒ³ãƒˆ
            marker.on('click', () => {
                updateInfoBox(spot); // æƒ…å ±ãƒœãƒƒã‚¯ã‚¹é€£å‹•
                marker.openPopup();
            });

            const name = currentLang === 'ja' ? spot.rec : spot.rec_en;
            const desc = spot.desc || "Recommended by Travel ID";
            marker.bindPopup(`<div class="map-card"><h4>${name}</h4><p>${desc}</p></div>`);
            
            markers.push(marker);
            bounds.push([spot.lat, spot.lng]);
        });

        // å…¨ãƒ”ãƒ³ãŒè¦‹ãˆã‚‹ç¯„å›²ã«ã‚ºãƒ¼ãƒ 
        if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    function toggleLanguage() {
        currentLang = currentLang === 'ja' ? 'en' : 'ja';
        document.getElementById('lang-btn').innerText = currentLang === 'ja' ? "ğŸ‡¯ğŸ‡µ JP / ğŸ‡ºğŸ‡¸ EN" : "ğŸ‡ºğŸ‡¸ EN / ğŸ‡¯ğŸ‡µ JP";
        updateResultUI();
    }
    
    function shareOnX() {
        const url = window.location.href;
        window.open(`https://twitter.com/intent/tweet?text=My Travel ID: ${finalId}&url=${encodeURIComponent(url)}`, '_blank');
    }
    
    function copyForDiscord() {
        navigator.clipboard.writeText(`My Travel ID: ${finalId}\n${window.location.href}`).then(() => alert("Copied!"));
    }
</script>
</body>
</html>