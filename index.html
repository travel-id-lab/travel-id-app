<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel ID - Value Segmentation</title>
    <link rel="icon" href="./images/logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root{
            --primary: #111827; /* Dark Slate */
            --secondary: #6b7280; /* Gray */
            --accent: #2563eb; /* Blue */
            --bg: #ffffff;
            --border: #e5e7eb;
            /* Scale Colors */
            --scale-5: #111827; /* Strong Agree */
            --scale-4: #4b5563; /* Agree */
            --scale-3: #9ca3af; /* Neutral */
            --scale-2: #d1d5db; /* Disagree */
            --scale-1: #f3f4f6; /* Strong Disagree */
        }
        body{font-family: 'Inter', sans-serif; background-color:#f3f4f6; color:var(--primary); margin:0; padding:20px; line-height:1.6;}
        .container{background:var(--bg); width:100%; max-width:480px; margin:0 auto; padding:0; min-height:90vh; display:flex; flex-direction:column; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-radius: 16px; overflow:hidden;}
        
        /* Typography & Layout */
        .header { padding: 40px 24px; text-align: left; }
        .brand-tag { font-size: 11px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); display:block; margin-bottom: 12px;}
        h1 { font-size: 36px; font-weight: 900; margin: 0; letter-spacing: -1.5px; line-height: 1; color: var(--primary); }
        .hero-sub { font-size: 16px; color: var(--secondary); margin-top: 16px; font-weight: 400; line-height: 1.5; }

        /* Buttons */
        .btn-primary {
            background: var(--primary); color: white; border: none; font-size: 16px; padding: 18px; width: 100%; 
            border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary::after { content: "‚Üí"; font-weight: 800; opacity: 0.8; }

        /* Quiz UI - 5 Scale */
        #quiz-screen { padding: 30px 24px; }
        .progress-track { height: 4px; background: #f1f5f9; margin-bottom: 30px; border-radius: 2px; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .q-cat { font-size: 10px; font-weight: 800; color: var(--accent); letter-spacing: 1px; margin-bottom: 8px; display: block; text-transform: uppercase;}
        .q-text { font-size: 20px; font-weight: 800; margin-bottom: 30px; min-height: 70px; line-height: 1.35; letter-spacing: -0.3px;}
        
        /* 5-Option Styling */
        .opt-btn {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 14px 20px; margin-bottom: 8px;
            border: 1px solid var(--border); border-radius: 10px;
            text-align: left; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.1s;
        }
        /* Gradient of intensity */
        .opt-5 { background: var(--scale-5); color: white; border-color: var(--scale-5); }
        .opt-4 { background: white; color: var(--primary); border-left: 5px solid var(--scale-5); }
        .opt-3 { background: white; color: var(--secondary); border-left: 2px solid var(--scale-3); font-weight:500;}
        .opt-2 { background: white; color: var(--secondary); border-left: 1px solid var(--scale-2); font-weight:500;}
        .opt-1 { background: #f9fafb; color: #9ca3af; border: 1px solid transparent; font-weight:500;}

        .opt-btn:active { transform: scale(0.99); opacity: 0.9; }

        /* Result Dashboard */
        #result-screen { flex-grow: 1; display: flex; flex-direction: column; }
        .res-header { padding: 24px; border-bottom: 1px solid var(--border); background: white;}
        .id-label { font-size: 10px; font-weight: 800; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px; }
        .id-title { font-size: 28px; font-weight: 900; margin: 5px 0 8px; color: var(--primary); letter-spacing: -1px; }
        .id-desc { font-size: 13px; color: var(--secondary); line-height: 1.5; margin-bottom: 15px;}
        
        .tribe-actions { display: flex; gap: 10px; margin-top: 10px; }
        .tribe-btn { flex: 1; font-size: 11px; padding: 12px; border-radius: 6px; background: #f8fafc; color: var(--secondary); text-align: center; text-decoration: none; border: 1px solid var(--border); font-weight: 600; display:flex; align-items:center; justify-content:center; gap:5px;}
        .tribe-btn:hover { background: #f1f5f9; color: var(--primary); }

        /* Controls */
        .controls { display: flex; padding: 10px 24px; gap: 8px; background: white; border-bottom: 1px solid var(--border);}
        .ctrl-pill { padding: 6px 12px; font-size: 12px; font-weight: 600; border-radius: 20px; cursor: pointer; background: #f1f5f9; color: var(--secondary); border: 1px solid transparent;}
        .ctrl-pill.active { background: var(--primary); color: white; }
        .ctrl-share { margin-left: auto; background: white; border-color: var(--border); color: var(--primary); }

        /* Map */
        #map-container { flex-grow: 1; background: #e2e8f0; position: relative; z-index: 1; min-height: 400px;}
        #map { width: 100%; height: 100%; }

        /* Floating Card */
        .spot-card {
            background: white; border-top: 1px solid var(--border); padding: 24px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.08); z-index: 100;
        }
        .spot-h { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .spot-n { font-size: 16px; font-weight: 700; margin: 0; }
        .spot-d { font-size: 13px; color: var(--secondary); margin-bottom: 20px; }
        .actions { display: flex; gap: 10px; }
        .act-btn { flex: 1; padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 600; text-align: center; cursor: pointer; border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; gap: 6px; text-decoration: none; color: var(--primary); transition:0.2s;}
        .act-save.saved { background: #fdf2f8; color: #db2777; border-color: #fbcfe8; }
        .act-vibe { background: var(--primary); color: white; border-color: var(--primary); }

        /* Utility */
        .hidden { display: none !important; }
        .lang-switch { position: absolute; top: 20px; right: 24px; font-size: 11px; font-weight: 700; color: var(--secondary); cursor: pointer; z-index: 20;}

        /* Leaflet Pins */
        img.leaflet-marker-icon { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .pin-sys { filter: hue-rotate(230deg) saturate(0.8) brightness(0.8); } 
        .pin-sav { filter: hue-rotate(320deg) saturate(2); transform: scale(1.3) translateY(-10px); z-index: 1000 !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-switch" onclick="toggleLang()" id="lang-btn">EN / JP</div>

    <div id="start-screen" class="header">
        <span class="brand-tag">Travel ID</span>
        <h1 id="t-head">Decode Your<br>Travel DNA.</h1>
        <p class="hero-sub" id="t-sub">We don't match you by demographics.<br>We match you by values.</p>
        
        <button class="btn-primary" onclick="startQuiz()" id="t-start">Analyze My Style</button>
        
        <div style="margin-top:40px; border-top:1px solid #e5e7eb; padding-top:20px;">
            <p style="font-size:11px; color:#9ca3af; line-height:1.5;">
                v25.0 (5-Scale Precision)<br>
                Powered by Human Intelligence & Values.
            </p>
        </div>
    </div>

    <div id="quiz-screen" class="hidden">
        <div class="progress-track"><div class="progress-bar" id="progress"></div></div>
        <span class="q-cat" id="q-cat">CATEGORY</span>
        <div class="q-text" id="q-text">Loading...</div>
        <div id="options-box"></div>
        <div style="margin-top:30px; text-align:center;">
            <span onclick="prevQ()" style="font-size:12px; color:#9ca3af; cursor:pointer; text-decoration:underline;">Back</span>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        
        <div class="res-header">
            <span class="id-label">YOUR SEGMENT</span>
            <h1 class="id-title" id="res-id">Loading...</h1>
            <p class="id-desc" id="res-desc">Analysis complete.</p>
            
            <div class="tribe-actions">
                <a href="https://forms.gle/5L7ndRzgPnh45Mor8" target="_blank" class="tribe-btn">
                    <span>‚ö°</span> Submit a Hidden Spot
                </a>
            </div>
        </div>

        <div class="controls">
            <div class="ctrl-pill active" onclick="setMode('japan')" id="opt-japan">Japan</div>
            <div class="ctrl-pill" onclick="setMode('world')" id="opt-world">Global</div>
            <div class="ctrl-pill ctrl-share" onclick="shareMap()">üîó Share Map</div>
        </div>

        <div id="map-container"><div id="map"></div></div>

        <div class="spot-card">
            <h3 class="spot-n" id="spot-name">Explore your world</h3>
            <p class="spot-d" id="spot-desc">Select a pin to reveal spots curated for your DNA.</p>
            <div class="actions">
                <button class="act-btn act-save" id="btn-save" onclick="toggleSave()">
                    <span id="icon-save">‚ô°</span> <span id="txt-save">Save</span>
                </button>
                <a href="#" target="_blank" class="act-btn act-vibe" id="btn-insta">
                    <span>‚ñ∂</span> <span id="txt-insta">Vibe</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
    // --- CONFIGURATION ---
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRrOI46FP-ueet2ZD0xKG0r1_xFng90_PDr1Z-sm6OB5xe3I8m0nx5Q5aNIVxvRVi1QLczBbv4pdnAv/pub?output=csv'; 
    
    // --- STATE ---
    let lang = 'en'; 
    let mode = 'japan'; 
    let finalId = "";
    let map = null;
    let markers = [];
    let dataCache = {};
    let saved = new Set();
    let curSpot = null;

    // --- INIT ---
    function init(){
        const urlParams = new URLSearchParams(window.location.search);
        const sharedId = urlParams.get('id');
        const sharedSaved = urlParams.get('saved');
        const localSaved = JSON.parse(localStorage.getItem('tid_saved') || '[]');
        saved = new Set(localSaved);

        if(sharedId) {
            finalId = sharedId;
            fetchData(() => { showResultScreen(); });
        } else {
            fetchData();
            updateUIText();
        }
    }

    function fetchData(callback){
        Papa.parse(CSV_URL, {
            download: true, header: true, skipEmptyLines: true,
            complete: res => {
                res.data.forEach(r => {
                    if(r.id){
                        const k = r.id.trim();
                        if(!dataCache[k]) dataCache[k] = [];
                        dataCache[k].push({
                            uid: r.uid || Math.random().toString(), 
                            name_jp: r.rec_jp, name_en: r.rec_en,
                            desc: r.desc, tag: r.tag ? r.tag.trim() : "",
                            lat: parseFloat(r.lat), lng: parseFloat(r.lng), 
                            zoom: parseInt(r.zoom)||12, region: r.region ? r.region.trim().toLowerCase() : 'japan'
                        });
                    }
                });
                if(callback) callback();
            }
        });
    }

    // --- TEXT & BRAND ---
    const T = {
        en: {
            head: "Decode Your\nTravel DNA.", sub: "We don't match you by demographics.\nWe match you by values.",
            start: "Analyze My Style", save: "Save to Map", saved: "Saved", vibe: "View Vibe",
            world: "Global", japan: "Domestic", share: "üîó Share Map",
            types: {
                "Ê≥•ÊîªÂ≠§ÈÅä": { t: "The Unfiltered Explorer", d: "Raw √ó Intense √ó Solo √ó Spontaneous.\nA nomad who seeks truth over comfort. You find beauty in the chaos that others reject." },
                "ÊµÑÂÆâÂÖ±Âæã": { t: "The Aesthetic Planner", d: "Refined √ó Gentle √ó Social √ó Structured.\nA guardian of beauty. You curate perfect harmony and reject the noise of the world." },
                "Ê≥•ÂÆâÂÖ±ÈÅä": { t: "The Immersion Seeker", d: "Raw √ó Gentle √ó Social √ó Spontaneous.\nA connector of souls. You dive into local life with an open heart and zero judgement." },
                "ÊµÑÊîªÂ≠§Âæã": { t: "The Noble Sniper", d: "Refined √ó Intense √ó Solo √ó Structured.\nA stoic perfectionist. You don't tour; you hunt for the sublime moment in solitude." },
                "default": { t: "The Unique Voyager", d: "Your value map is unique. Explore the map to find your tribe." }
            }
        },
        ja: {
            head: "ÊóÖ„ÅÆDNA„Çí\nËß£Ë™≠„Åô„Çã„ÄÇ", sub: "Â±ûÊÄß„Åß„ÅØ„Å™„Åè„ÄÅ\n„Äå‰æ°ÂÄ§Ë¶≥„Äç„Åß‰∏ñÁïå„ÇíÂÜçÂÆöÁæ©„Åô„Çã„ÄÇ",
            start: "„Çπ„Çø„Ç§„É´„ÇíÂàÜÊûê", save: "‰øùÂ≠ò„Åô„Çã", saved: "‰øùÂ≠òÊ∏à", vibe: "ÂãïÁîª„ÇíË¶ã„Çã",
            world: "‰∏ñÁïå", japan: "Êó•Êú¨", share: "üîó Âú∞Âõ≥„Çí„Ç∑„Çß„Ç¢",
            types: {
                "Ê≥•ÊîªÂ≠§ÈÅä": { t: "The Unfiltered Explorer", d: "„ÄêRaw √ó Intense √ó Solo √ó Spontaneous„Äë\nÈ£æ„Çâ„Å™„ÅÑÊé¢Á©∂ËÄÖ„ÄÇÂÆâÂÖ®„Å™È£ºËÇ≤Â∞èÂ±ã„Çà„Çä„ÄÅÂÇ∑„Å†„Çâ„Åë„ÅÆËçíÈáé„ÇíÈÅ∏„Å∂„ÄÇ„Ç´„Ç™„Çπ„ÅÆ‰∏≠„Å´„Åì„Åù„ÄåÁîü„Äç„Åå„ÅÇ„Çã„ÄÇ" },
                "ÊµÑÂÆâÂÖ±Âæã": { t: "The Aesthetic Planner", d: "„ÄêRefined √ó Gentle √ó Social √ó Structured„Äë\nÁæéÂ≠¶„ÅÇ„ÇãË®àÁîªËÄÖ„ÄÇ„Éé„Ç§„Ç∫„ÇíÂæπÂ∫ï„Åó„Å¶ÊéíÈô§„Åó„ÄÅÂú∞‰∏ä„Å´ÂÆåÁíß„Å™Ê•ΩÂúíÔºà„Çµ„É≥„ÇØ„ÉÅ„É•„Ç¢„É™Ôºâ„ÇíË®≠Ë®à„Åô„Çã„ÄÇ" },
                "Ê≥•ÂÆâÂÖ±ÈÅä": { t: "The Immersion Seeker", d: "„ÄêRaw √ó Gentle √ó Social √ó Spontaneous„Äë\nÊ≤°ÂÖ•„Åô„Çã‰∫∫„ÄÇÊ∏ÖÊøÅ‰Ωµ„ÅõÂëë„ÇÄÊúÄÂº∑„ÅÆÂÖçÁñ´Âäõ„Åß„ÄÅ„Å©„Çì„Å™Ë∑ØÂú∞Ë£è„Å´„ÇÇ„ÄåÊÑõ„Äç„ÇíË¶ã„Å§„ÅëÂá∫„Åô„ÄÇ" },
                "ÊµÑÊîªÂ≠§Âæã": { t: "The Noble Sniper", d: "„ÄêRefined √ó Intense √ó Solo √ó Structured„Äë\nÂ≠§È´ò„ÅÆÁãôÊíÉÊâã„ÄÇÂ¶•Âçî„Å™„ÅçÁæéÊÑèË≠ò„ÄÇ„ÅÇ„Å™„Åü„Åå„Åô„Çã„ÅÆ„ÅØË¶≥ÂÖâ„Åß„ÅØ„Å™„ÅÑ„ÄÅÁæé„ÇíÊíÉ„Å°Êäú„Åè„ÄåÁã©„Çä„Äç„Å†„ÄÇ" },
                "default": { t: "The Unique Voyager", d: "Áã¨Ëá™„ÅÆÊóÖ„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éû„ÉÉ„Éó„ÇíÊé¢Á¥¢„Åó„Å¶„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Éà„É©„Ç§„ÉâÔºàÈÉ®ÊóèÔºâ„ÇíË¶ã„Å§„Åë„Åæ„Åó„Çá„ÅÜ„ÄÇ" }
            }
        }
    };

    const Q = [
        { cat: "ENVIRONMENT", ja: "Áµ∂ÊôØ„ÅÆ‰ª£ÂÑü„Åå‰∏çË°õÁîü„Å™Â∞èÂ±ã„Å†„Å®„Åó„Å¶„ÇÇ„ÄÅ„Åù„Åì„Å´Ê≥ä„Åæ„Çã„ÅãÔºü", en: "Would you sleep in a dirty hut for a priceless view?", pos:{mud:2}, neg:{clean:2} },
        { cat: "CONSUMPTION", ja: "Âæó‰Ωì„ÅÆÁü•„Çå„Å™„ÅÑÁèæÂú∞„ÅÆÂ±ãÂè∞ÊñôÁêÜ„ÄÇ„É™„Çπ„ÇØ„ÇíË≤†„Å£„Å¶„Åß„ÇÇÈ£ü„Åπ„Çã„ÅãÔºü", en: "Do you eat mysterious local street food despite risks?", pos:{mud:2}, neg:{clean:2} },
        { cat: "ISOLATION", ja: "ÊñáÊòé„Åã„ÇâÂàáÊñ≠„Åï„Çå„Åü‰∏ç‰æø„Å™Â†¥ÊâÄ„ÄÇ„Åù„Çå„ÅØËã¶Áóõ„Åã„ÄÅËß£Êîæ„ÅãÔºü", en: "Is total isolation from civilization 'pain' or 'freedom'?", pos:{mud:1,solo:1}, neg:{clean:1,social:1} },
        { cat: "UNCERTAINTY", ja: "Âú∞Âõ≥„ÇíÊåÅ„Åü„Åö„Å´Ëø∑Â≠ê„Å´„Å™„Çã„Åì„Å®„ÄÇ„Åù„Çå„ÅØ„Çπ„Éà„É¨„Çπ„Åã„ÄÅÂñú„Å≥„ÅãÔºü", en: "Is getting lost without a map 'stress' or 'joy'?", pos:{flow:2}, neg:{order:2} },
        { cat: "CONTROL", ja: "ÂàÜÂçò‰Ωç„ÅßÂÆåÁíß„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„ÄÇÂÆâÂøÉ„Åô„Çã„Åã„ÄÅÊÅØËã¶„Åó„ÅÑ„ÅãÔºü", en: "Does a perfect schedule make you feel 'safe' or 'trapped'?", pos:{order:2}, neg:{flow:2} },
        { cat: "ADAPTABILITY", ja: "ÊóÖ„ÅÆ„Éà„É©„Éñ„É´„ÅØ„Äå„Ç®„É©„Éº„Äç„Åã„ÄÅ„Åù„Çå„Å®„ÇÇ„Äå„Éâ„É©„Éû„Äç„ÅãÔºü", en: "Are travel troubles 'errors' or 'drama'?", pos:{flow:2}, neg:{order:2} },
        { cat: "INTENSITY", ja: "ÊóÖ„ÅÆÁõÆÁöÑ„ÅØ„ÄåÁôí„ÇÑ„Åó„Äç„Åã„ÄÅ„Åù„Çå„Å®„ÇÇ„ÄåÊ∂àËÄó„Äç„ÅãÔºü", en: "Is the goal of travel 'healing' or 'exhaustion'?", pos:{safe:2}, neg:{active:2} },
        { cat: "RISK", ja: "Ê≤ªÂÆâ„ÅÆÊÇ™„ÅÑ„Çπ„É©„É†Ë°ó„ÄÇÂÆâÂÖ®Âúè„Åã„ÇâË¶ã„Çã„Åã„ÄÅÈôç„Çä„Å¶Ê≠©„Åè„ÅãÔºü", en: "Would you walk inside a gritty slum or watch from a bus?", pos:{active:2}, neg:{safe:2} },
        { cat: "INVESTMENT", ja: "‰∫àÁÆó„Çí‰Ωø„ÅÜ„Å™„Çâ„ÄåÊ•µ‰∏ä„ÅÆÂÆâÊÅØ„Äç„Åã„ÄÅ„ÄåÊ•µÈôê„ÅÆ‰ΩìÈ®ì„Äç„ÅãÔºü", en: "Invest in 'luxury rest' or 'extreme experience'?", pos:{safe:2}, neg:{active:2} },
        { cat: "SOLITUDE", ja: "Â§ßËá™ÁÑ∂„ÅÆ‰∏≠„Åß„ÅÆÂ≠§Áã¨„ÄÇÂØÇ„Åó„ÅÑ„Åã„ÄÅÂÖ®ËÉΩÊÑü„ÇíÊÑü„Åò„Çã„ÅãÔºü", en: "Alone in nature: Do you feel 'lonely' or 'empowered'?", pos:{solo:2}, neg:{social:2} },
        { cat: "CONNECTION", ja: "Ë®ÄËëâ„ÅÆÈÄö„Åò„Å™„ÅÑÁèæÂú∞‰∫∫„Å®„ÅÆ‰∫§ÊµÅ„ÄÇÈÅø„Åë„Çã„Åã„ÄÅÈ£õ„Å≥Ëæº„ÇÄ„ÅãÔºü", en: "Interacting with locals: Avoid or Dive in?", pos:{social:2}, neg:{solo:2} },
        { cat: "PARTNER", ja: "ÂêåË°åËÄÖ„ÅØ„ÄåÂæìÈ†Ü„Å™‰∫∫„Äç„Åã„ÄÅ„ÄåÊåØ„ÇäÂõû„Åó„Å¶„Åè„Çã‰∫∫„Äç„ÅãÔºü", en: "Partner preference: 'Obedient' or 'Crazy'?", pos:{social:1,flow:1}, neg:{solo:1,order:1} },
        { cat: "CORE", ja: "ÊóÖ„Å®„ÅØ„ÄåÊó•Â∏∏„ÅÆÂõûÂæ©„Äç„Åã„ÄÅ„Åù„Çå„Å®„ÇÇ„Äå‰æ°ÂÄ§Ë¶≥„ÅÆÁ†¥Â£ä„Äç„ÅãÔºü", en: "Travel is: 'Restoring daily life' or 'Destroying values'?", pos:{active:2,mud:1}, neg:{safe:2,clean:1} }
    ];

    let qIdx = 0;
    let scores = {mud:0, clean:0, flow:0, order:0, active:0, safe:0, solo:0, social:0};

    // --- LOGIC ---
    function toggleLang(){
        lang = lang==='en' ? 'ja' : 'en';
        updateUIText();
        if(qIdx>0 && qIdx<Q.length) renderQ(); // Re-render if in quiz
        else if(finalId) updateResultUI(); // Re-render if in result
    }

    function updateUIText(){
        const t = T[lang];
        document.getElementById('t-head').innerHTML = t.head.replace('\n', '<br>');
        document.getElementById('t-sub').innerHTML = t.sub.replace('\n', '<br>');
        document.getElementById('t-start').innerText = t.start;
        document.getElementById('lang-btn').innerText = lang==='en' ? "EN / JP" : "JP / EN";
    }

    function startQuiz(){
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        renderQ();
    }

    function renderQ(){
        if(qIdx >= Q.length){ finishQuiz(); return; }
        const q = Q[qIdx];
        document.getElementById('q-cat').innerText = q.cat;
        document.getElementById('q-text').innerText = lang==='ja' ? q.ja : q.en;
        document.getElementById('progress').style.width = `${((qIdx)/Q.length)*100}%`;
        
        const box = document.getElementById('options-box');
        box.innerHTML = '';
        
        // 5 Options with Weights
        const opts = [
            { l: lang==='ja'?"Âº∑„Åè„Åù„ÅÜÊÄù„ÅÜ":"Strongly Agree", w: 2, c: "opt-5" },
            { l: lang==='ja'?"„Åù„ÅÜÊÄù„ÅÜ":"Agree", w: 1, c: "opt-4" },
            { l: lang==='ja'?"„Å©„Å°„Çâ„Åß„ÇÇ„Å™„ÅÑ":"Neutral", w: 0, c: "opt-3" },
            { l: lang==='ja'?"„Åù„ÅÜÊÄù„Çè„Å™„ÅÑ":"Disagree", w: -1, c: "opt-2" },
            { l: lang==='ja'?"ÂÖ®„Åè„Åù„ÅÜÊÄù„Çè„Å™„ÅÑ":"Strongly Disagree", w: -2, c: "opt-1" }
        ];

        opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = `opt-btn ${o.c}`;
            btn.innerHTML = `<span>${o.l}</span>`; // Text
            btn.onclick = () => {
                // Scoring Logic with Multiplier
                // Positive Weight adds to Positive Traits
                if(o.w > 0) Object.keys(q.pos).forEach(k => scores[k] += q.pos[k] * o.w);
                // Negative Weight adds to Negative Traits (using absolute value)
                if(o.w < 0) Object.keys(q.neg).forEach(k => scores[k] += q.neg[k] * Math.abs(o.w));
                
                qIdx++;
                renderQ();
            };
            box.appendChild(btn);
        });
    }

    function prevQ(){
        if(qIdx > 0){ qIdx--; renderQ(); }
        else { location.reload(); }
    }

    function finishQuiz(){
        const axis1 = scores.mud >= scores.clean ? "Ê≥•" : "ÊµÑ";
        const axis2 = scores.active >= scores.safe ? "Êîª" : "ÂÆâ";
        const axis3 = scores.social >= scores.solo ? "ÂÖ±" : "Â≠§";
        const axis4 = scores.flow >= scores.order ? "ÈÅä" : "Âæã";
        finalId = axis1 + axis2 + axis3 + axis4;
        showResultScreen();
    }

    function showResultScreen(){
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        updateResultUI();
        setTimeout(initMap, 200);
    }

    function updateResultUI(){
        const tData = T[lang].types[finalId] || T[lang].types["default"];
        document.getElementById('res-id').innerText = tData.t;
        document.getElementById('res-desc').innerText = tData.d;
        
        const t = T[lang];
        document.getElementById('opt-world').innerText = t.world;
        document.getElementById('opt-japan').innerText = t.japan;
        document.querySelector('.ctrl-share').innerText = t.share;
        
        if(map) updateMap();
    }

    function setMode(m){
        mode = m;
        document.getElementById('opt-world').classList.toggle('active', m==='world');
        document.getElementById('opt-japan').classList.toggle('active', m==='japan');
        updateMap();
    }

    function initMap(){
        if(map) { map.invalidateSize(); return; }
        map = L.map('map');
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 19
        }).addTo(map);
        updateMap();
    }

    function updateMap(){
        if(!map) return;
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        const allSpots = dataCache[finalId] || [];
        let spots = [];
        if(mode === 'japan') spots = allSpots.filter(s => s.region === 'japan');
        else spots = allSpots.filter(s => s.region === 'world');

        if(spots.length === 0) return;

        const bounds = [];
        spots.forEach(s => {
            const isSaved = saved.has(s.uid);
            const cls = isSaved ? 'pin-sav' : 'pin-sys';
            const icon = L.divIcon({className:'', html:`<img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="leaflet-marker-icon ${cls}" style="margin-left:-12px; margin-top:-41px;">`});
            
            const m = L.marker([s.lat, s.lng], {icon:icon}).addTo(map);
            m.on('click', () => showSpot(s));
            markers.push(m);
            bounds.push([s.lat, s.lng]);
        });

        if(spots.length===1) map.setView([spots[0].lat, spots[0].lng], spots[0].zoom);
        else map.fitBounds(bounds, {padding:[50,50]});

        showSpot(spots[0]);
    }

    function showSpot(s){
        curSpot = s;
        const n = lang==='ja' ? (s.name_jp||s.rec) : (s.name_en||s.rec);
        document.getElementById('spot-name').innerText = n;
        document.getElementById('spot-desc').innerText = s.desc || "Recommended Spot";
        
        const btnInsta = document.getElementById('btn-insta');
        if(s.tag){
            btnInsta.href = `https://www.instagram.com/explore/tags/${s.tag}/`;
            btnInsta.style.opacity = 1; btnInsta.style.pointerEvents = 'auto';
        } else {
            btnInsta.style.opacity = 0.5; btnInsta.style.pointerEvents = 'none';
        }
        updateSaveBtn();
    }

    function toggleSave(){
        if(!curSpot) return;
        const k = curSpot.uid;
        if(saved.has(k)) saved.delete(k); else saved.add(k);
        localStorage.setItem('tid_saved', JSON.stringify([...saved]));
        updateSaveBtn();
        updateMap();
    }

    function updateSaveBtn(){
        if(!curSpot) return;
        const isSaved = saved.has(curSpot.uid);
        const btn = document.getElementById('btn-save');
        const icon = document.getElementById('icon-save');
        const txt = document.getElementById('txt-save');
        const t = T[lang];

        if(isSaved){
            btn.classList.add('saved');
            icon.innerText = '‚ô•';
            txt.innerText = t.saved;
        } else {
            btn.classList.remove('saved');
            icon.innerText = '‚ô°';
            txt.innerText = t.save;
        }
    }

    function shareMap() {
        const savedArr = Array.from(saved);
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = `${baseUrl}?id=${finalId}&saved=${savedArr.join(',')}`;
        
        navigator.clipboard.writeText(shareUrl).then(() => {
            alert(lang==='ja' ? "URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅÂèãÈÅî„Å´„Ç∑„Çß„Ç¢„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ" : "URL copied! Share it with your tribe.");
        });
    }

    init();
</script>
</body>
</html>